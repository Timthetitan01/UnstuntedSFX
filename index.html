<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNSTUNTED SFX</title>
    <link rel="icon" type="image/png" href="UNSTUNTED_LOGO.png">
    <script src="https://js.stripe.com/v3/"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-body: #f5f5f7;
            --bg-surface: #ffffff;
            --bg-surface-hover: #fbfbfd;
            --text-main: #1d1d1f;
            --text-muted: #6e6e73;
            --border: rgba(0,0,0,0.08);
            --accent: #0071e3;
            --accent-glow: rgba(0, 113, 227, 0.15);
            --radius-lg: 18px;
            --radius-md: 12px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-surface: #121212;
            --bg-surface-hover: #1c1c1e;
            --text-main: #f5f5f7;
            --text-muted: #a1a1a6;
            --border: rgba(255,255,255,0.12);
            --accent: #2997ff;
            --accent-glow: rgba(41, 151, 255, 0.25);
            --shadow-md: 0 12px 40px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 160px;
            transition: background 0.4s ease;
            -webkit-font-smoothing: antialiased;
            line-height: 1.5;
        }

        /* --- HERO --- */
        .hero {
            height: 320px;
            background: radial-gradient(circle at 70% 20%, var(--accent-glow) 0%, transparent 50%),
                        linear-gradient(180deg, var(--bg-surface) 0%, var(--bg-body) 100%);
            display: flex; flex-direction: column; justify-content: center;
            padding: 0 2rem;
            text-align: center;
        }
        
        .brand-large {
            font-size: clamp(2.5rem, 8vw, 5rem); 
            font-weight: 800; 
            letter-spacing: -0.05em;
            background: linear-gradient(135deg, var(--text-main) 30%, var(--accent) 100%);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            max-width: 1200px; margin: 0 auto; width: 100%;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.1));
        }

        /* --- NAVIGATION --- */
        .sticky-nav {
            position: sticky; top: 0;
            z-index: 1000;
            background: rgba(var(--bg-body), 0.75);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 0;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }
        
        .nav-content {
            max-width: 1200px; margin: 0 auto; padding: 0 2rem;
            display: flex; flex-direction: column; gap: 1rem;
        }

        .top-row { display: flex; justify-content: space-between; align-items: center; }

        /* Auth Buttons */
        .auth-actions { display: flex; gap: 12px; align-items: center; }
        .btn-primary {
            background: var(--text-main); color: var(--bg-body); border: none;
            padding: 10px 20px; border-radius: 24px; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; transition: all 0.2s var(--ease); display: flex; align-items: center; gap: 8px;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--accent-glow); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-sub { background: var(--accent); color: white; border: 1px solid transparent; }
        
        .user-avatar { 
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: none; 
            border: 2px solid var(--border); transition: 0.2s; padding: 2px;
        }
        .user-avatar:hover { border-color: var(--accent); transform: scale(1.1); }
        
        .tier-tag { 
            font-size: 0.7rem; font-weight: 800; color: var(--accent); 
            border: 1px solid var(--accent); padding: 3px 10px; border-radius: 8px; 
            display: none; margin-right: 10px; letter-spacing: 0.05em; 
        }

        /* Controls */
        .type-switcher { 
            display: inline-flex; background: var(--bg-surface-hover); 
            padding: 4px; border-radius: 12px; border: 1px solid var(--border); 
        }
        .type-btn { 
            padding: 8px 20px; border-radius: 9px; border: none; background: transparent; 
            color: var(--text-muted); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
        }
        .type-btn.active { background: var(--bg-surface); color: var(--text-main); box-shadow: var(--shadow-sm); }

        .sub-filters { 
            display: flex; gap: 0.75rem; overflow-x: auto; padding: 4px 0 10px; 
            scrollbar-width: none; mask-image: linear-gradient(to right, black 90%, transparent);
        }
        .chip { 
            padding: 0.5rem 1.25rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; 
            background: var(--bg-surface); color: var(--text-muted); border: 1px solid var(--border); 
            cursor: pointer; white-space: nowrap; transition: 0.2s; 
        }
        .chip:hover { border-color: var(--text-muted); }
        .chip.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 12px var(--accent-glow); }

        /* --- SEARCH & LIST --- */
        .container { max-width: 1200px; margin: 3rem auto; padding: 0 2rem; }

        .search-wrap { margin-bottom: 2.5rem; position: relative; max-width: 500px; }
        .search-input { 
            width: 100%; padding: 1.1rem 3.5rem; background: var(--bg-surface); 
            border: 1px solid var(--border); border-radius: 20px; color: var(--text-main); 
            font-size: 1rem; transition: 0.3s var(--ease); box-shadow: var(--shadow-sm);
        }
        .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }
        .search-icon { position: absolute; left: 1.4rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 20px; pointer-events: none; }
        
        .track-list { display: flex; flex-direction: column; gap: 4px; }

        .track-row {
            display: grid; grid-template-columns: 50px 2fr 120px 80px 100px 120px;
            align-items: center; background: transparent; padding: 0.75rem 1rem; 
            border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s var(--ease);
            border-bottom: 1px solid var(--border);
        }
        .track-row:hover { background: var(--bg-surface); transform: translateX(4px); border-color: transparent; box-shadow: var(--shadow-sm); }
        .track-row.playing { background: var(--bg-surface-hover); border-color: var(--accent-glow); }
        .track-row.playing h3 { color: var(--accent); }

        .play-btn-small { 
            width: 34px; height: 34px; border-radius: 50%; background: var(--bg-surface-hover); 
            border: 1px solid var(--border); color: var(--text-main); display: flex; 
            align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; 
        }
        .track-row:hover .play-btn-small { background: var(--text-main); color: var(--bg-body); border-color: var(--text-main); }
        .track-row.playing .play-btn-small { background: var(--accent); color: white; border-color: var(--accent); }

        .track-info h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
        .track-info span { font-size: 0.8rem; color: var(--text-muted); }
        
        .badge { 
            background: var(--bg-surface-hover); padding: 4px 10px; border-radius: 6px; 
            font-size: 0.65rem; font-weight: 700; color: var(--text-muted); 
            text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid var(--border);
        }
        .meta { color: var(--text-muted); font-size: 0.85rem; font-family: "SF Mono", monospace; }
        
        .col-action { display: flex; gap: 8px; justify-content: flex-end; opacity: 0.4; transition: 0.2s; }
        .track-row:hover .col-action { opacity: 1; }
        
        .action-btn { 
            width: 36px; height: 36px; border-radius: 10px; border: 1px solid transparent; 
            background: transparent; color: var(--text-muted); cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .action-btn:hover { background: var(--bg-surface-hover); color: var(--text-main); border-color: var(--border); }
        .action-btn.liked { color: #ff3b30; }
        .action-btn.locked { opacity: 0.4; filter: grayscale(1); }

        /* Visualizer */
        .visualizer { display: flex; align-items: center; gap: 3px; height: 20px; opacity: 0; transition: 0.3s; }
        .track-row.playing .visualizer { opacity: 1; }
        .v-bar { width: 3px; background: var(--accent); border-radius: 1px; }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            width: 92%; max-width: 800px;
            background: rgba(20, 20, 22, 0.85); backdrop-filter: blur(30px) saturate(200%);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; padding: 1rem 1.5rem;
            display: flex; flex-direction: column; box-shadow: var(--shadow-md); z-index: 2000;
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        [data-theme="light"] .player-bar { 
            background: rgba(255, 255, 255, 0.85); 
            border-color: rgba(0,0,0,0.05);
            box-shadow: 0 10px 50px rgba(0,0,0,0.1);
        }
        .player-bar.active { transform: translateX(-50%) translateY(0); }

        .player-top { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 0.5rem; }
        .p-info { display: flex; align-items: center; gap: 1rem; min-width: 200px; }
        .p-art { 
            width: 44px; height: 44px; background: linear-gradient(135deg, #222, #000); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .p-text h4 { font-size: 0.9rem; margin-bottom: 1px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-text span { font-size: 0.75rem; color: var(--text-muted); }
        
        .p-controls { display: flex; align-items: center; gap: 1.25rem; }
        .btn-ctrl { background: none; border: none; color: var(--text-main); cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .btn-ctrl:hover { opacity: 1; transform: scale(1.1); }
        .btn-play-lg { 
            width: 52px; height: 52px; background: var(--text-main); color: var(--bg-body); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .player-bottom { display: flex; align-items: center; gap: 1rem; width: 100%; }
        .time-display { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; font-family: monospace; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; flex: 1; height: 18px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--border); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: var(--text-main); margin-top: -4px; transition: 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.3); }

        /* --- PRICING REDESIGN (FIXED & EVEN) --- */
        .modal-pricing-content { 
            max-width: 1200px; /* Force wide width */
            width: 95%;        
            padding: 40px; 
            background: var(--bg-body);
            border: 1px solid var(--border);
            overflow: visible; 
        }

        .pricing-header {
            text-align: center;
            margin-bottom: 2.5rem;
            position: relative; z-index: 2;
        }
        .pricing-header h2 {
            font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(135deg, var(--text-main) 0%, var(--text-muted) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Equal Columns */
            gap: 2rem; 
            margin-top: 1rem; 
            align-items: stretch; /* Make all cards same height */
            position: relative; z-index: 2;
        }

        .price-card {
            background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: 24px; padding: 2rem;
            display: flex; flex-direction: column; position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            min-height: 440px;
        }
        .price-card:hover { transform: translateY(-5px); border-color: var(--text-muted); }

        /* The Popular Card - NO SCALING */
        .price-card.popular {
            background: var(--bg-surface); 
            border: 2px solid var(--accent); /* Blue border to highlight instead of size */
            box-shadow: 0 0 40px var(--accent-glow);
            z-index: 1;
            padding: 2rem; 
            transform: none !important; /* Forces it to stay same size */
        }
        .price-card.popular:hover { transform: translateY(-5px) !important; }

        .pop-badge {
            position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 6px 16px; border-radius: 100px;
            font-size: 0.75rem; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
            box-shadow: 0 4px 12px var(--accent-glow); white-space: nowrap;
        }

        .price-title {
            font-size: 1.1rem; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;
        }

        .price-cost {
            display: flex; align-items: baseline; font-size: 3rem; font-weight: 800;
            color: var(--text-main); margin-bottom: 2rem; line-height: 1;
        }
        .price-cost .currency { font-size: 1.5rem; vertical-align: top; margin-right: 2px; }
        .price-cost .period { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; margin-left: 4px; }

        .feature-list { list-style: none; margin-bottom: auto; padding: 0; }
        .feature-list li {
            margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-muted);
            display: flex; align-items: center; gap: 12px;
        }
        .feature-list li svg {
            color: var(--accent); flex-shrink: 0; background: var(--accent-glow);
            padding: 3px; border-radius: 50%; width: 22px; height: 22px;
        }
        .feature-list li span { line-height: 1.3; }

        .btn-select-plan {
            width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border);
            font-weight: 700; cursor: pointer; font-size: 0.95rem; transition: 0.2s;
            background: transparent; color: var(--text-main); margin-top: 1.5rem;
        }
        .btn-select-plan:hover { background: var(--bg-surface-hover); border-color: var(--text-main); }

        .price-card.popular .btn-select-plan {
            background: var(--accent); color: white; border: none;
            box-shadow: 0 4px 15px var(--accent-glow);
        }
        .price-card.popular .btn-select-plan:hover { box-shadow: 0 8px 25px var(--accent-glow); transform: translateY(-2px); }

        /* --- TOAST & UTILS --- */
        .toast { 
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100px); 
            background: var(--text-main); color: var(--bg-body); padding: 12px 24px; 
            border-radius: 40px; font-weight: 600; font-size: 0.9rem; z-index: 9999; 
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* --- MODAL BASE --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(8px); z-index: 3000; display: none; 
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal.open { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background: var(--bg-surface); border-radius: 32px; width: 100%; 
            max-width: 440px; padding: 2.5rem; position: relative;
            box-shadow: var(--shadow-md); border: 1px solid var(--border);
            transform: scale(0.95); transition: 0.3s var(--ease);
        }
        .modal.open .modal-content { transform: scale(1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Pricing Close Button */
        .close-modal-btn {
            position: absolute; top: 20px; right: 20px;
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-surface-hover); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; z-index: 20; color: var(--text-muted);
        }
        .close-modal-btn:hover { background: var(--text-main); color: var(--bg-body); }

        /* --- RESPONSIVE --- */
        @media (max-width: 850px) {
            /* Pricing Mobile */
            .pricing-grid { grid-template-columns: 1fr; gap: 2rem; }
            .price-card { width: 100%; min-height: auto; }
            .price-card.popular { padding: 2rem; border-width: 2px; }
            .modal-pricing-content { padding: 30px 20px; }
            
            /* Main UI Mobile */
            .track-row { grid-template-columns: 50px 1fr 60px; grid-template-areas: "play info action"; gap: 0.5rem; }
            .col-play { grid-area: play; } .track-info { grid-area: info; } .col-action { grid-area: action; opacity: 1; }
            .col-meta, .visualizer { display: none; }
            .nav-content { padding: 0 1rem; }
            .player-bar { width: 95%; padding: 0.75rem 1rem; border-radius: 20px; bottom: 15px; }
            .vol-wrap { display: none; }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast">Welcome</div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')" style="position:absolute; top:20px; right:24px; cursor:pointer; font-size:1.5rem; color:var(--text-muted);">âœ•</span>
            <h2 style="margin-bottom:12px; font-weight:800;">Welcome Back</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem; font-size:0.95rem;">Join thousands of creators using Unstunted SFX assets.</p>
            <button class="google-btn" onclick="loginWithGoogle()" style="width:100%; padding:14px; border-radius:16px; border:1px solid var(--border); background:var(--bg-surface); color:var(--text-main); font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:12px; transition:0.2s;">
                <svg width="20" height="20" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
                Continue with Google
            </button>
        </div>
    </div>

    <div id="pricingModal" class="modal">
        <div class="modal-content modal-pricing-content">
            <div class="close-modal-btn" onclick="closeModal('pricingModal')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></svg>
            </div>
    
            <div class="pricing-header">
                <h2>Unleash Your Sound</h2>
                <p style="color:var(--text-muted);">Simple pricing. No hidden fees. Cancel anytime.</p>
            </div>
            
            <div class="pricing-grid">
                <div class="price-card">
                    <div class="price-title">Starter</div>
                    <div class="price-cost">
                        <span class="currency">$</span>3<span class="period">/mo</span>
                    </div>
                    <ul class="feature-list">
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>50 Downloads / mo</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>Standard MP3</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>Personal License</span>
                        </li>
                    </ul>
                    <button class="btn-select-plan" onclick="checkout('starter')">Choose Starter</button>
                </div>
    
                <div class="price-card popular">
                    <div class="pop-badge">Best Value</div>
                    <div class="price-title">Yearly Pro</div>
                    <div class="price-cost">
                        <span class="currency">$</span>30<span class="period">/yr</span>
                    </div>
                    <ul class="feature-list">
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span style="color:var(--text-main); font-weight:600;">Unlimited Downloads</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>High-Res WAV & FLAC</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>Commercial License</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>Priority Support</span>
                        </li>
                    </ul>
                    <button class="btn-select-plan" onclick="checkout('pro')">Upgrade to Pro</button>
                </div>
    
                <div class="price-card">
                    <div class="price-title">Lifetime</div>
                    <div class="price-cost">
                        <span class="currency">$</span>50<span class="period">/once</span>
                    </div>
                    <ul class="feature-list">
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>One-time Payment</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>Stem Separation</span>
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            <span>Future Updates</span>
                        </li>
                    </ul>
                    <button class="btn-select-plan" onclick="checkout('ultimate')">Get Lifetime</button>
                </div>
            </div>
        </div>
    </div>

    <div class="hero">
        <div class="brand-large">UNSTUNTED_SFX</div>
    </div>

    <div class="sticky-nav">
        <div class="nav-content">
            <div class="top-row">
                <div class="type-switcher">
                    <button class="type-btn active" onclick="updateType('all')">All Library</button>
                    <button class="type-btn" onclick="updateType('Music')">Music</button>
                    <button class="type-btn" onclick="updateType('SFX')">SFX</button>
                </div>
                
                <div class="auth-actions">
                    <button class="btn-primary" id="loginBtn" onclick="openModal('loginModal')">Sign In</button>
                    <button class="btn-primary btn-sub" id="subBtn" onclick="openModal('pricingModal')" style="display:none;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                        Subscribe
                    </button>
                    <span id="tierTag" class="tier-tag">FREE</span>
                    <img id="avatar" class="user-avatar" src="" alt="User" title="Click to Logout">
                    
                    <button class="play-btn-small" id="themeToggle" style="border-radius:12px;">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29zm1.41-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.29 1.29c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.29-1.29zM7.28 17.17c-.39-.39-1.02-.39-1.41 0a.996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29z"/></svg>
                    </button>
                </div>
            </div>
            <div class="sub-filters" id="subFilters"></div>
        </div>
    </div>

    <main class="container">
        <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Search by mood, gear, or category...">
            <button class="clear-search" id="clearSearch" style="position: absolute; right: 1.2rem; top: 50%; transform: translateY(-50%); background: var(--bg-surface-hover); border: 1px solid var(--border); border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); opacity: 0; pointer-events: none; transition: 0.2s;"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 19 17.59 13.41 12z"/></svg></button>
        </div>

        <div class="track-list" id="trackList"></div>
    </main>

    <div class="player-bar" id="playerBar">
        <div class="player-top">
            <div class="p-info">
                <div class="p-art"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg></div>
                <div class="p-text"><h4 id="pTitle">Ready to play</h4><span id="pArtist">Select a sound</span></div>
            </div>
            <div class="p-controls">
                <button class="btn-ctrl" onclick="playPrev()" title="Previous"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-ctrl btn-play-lg" id="mainPlayBtn"><svg id="mainPlayIcon" width="26" height="26" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-ctrl" onclick="playNext()" title="Next"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            </div>
            <div class="vol-wrap" style="display:flex; align-items:center; gap:0.75rem; min-width:120px; justify-content:flex-end;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="color:var(--text-muted);"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <input type="range" id="volBar" min="0" max="1" step="0.1" value="1" style="width:70px;">
            </div>
        </div>
        <div class="player-bottom">
            <span class="time-display" id="timeCurrent">0:00</span>
            <input type="range" class="seek-bar" id="seekBar" value="0" min="0" max="100">
            <span class="time-display" id="timeTotal">0:00</span>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // !!! PASTE YOUR CLOUDFLARE WORKER URL HERE !!!
        const WORKER_URL = "https://sonic-library-api.unstuntedyt.workers.dev"; 
        
        // Your R2 Public Bucket URL
        const R2_PUBLIC_URL = "https://pub-5b2715d43ab24b93979acc13060553d9.r2.dev";

        const STRIPE_PRICES = {
            'starter': 'https://buy.stripe.com/test_4gMbJ31wK78Q76M9Xd6Zy05', 
            'pro': 'https://buy.stripe.com/test_your_yearly_link...',      
            'ultimate': 'https://buy.stripe.com/test_your_lifetime_link...'  
        };

        const firebaseConfig = {
            apiKey: "AIzaSyCz9644Ha8aRtEb4aTNF6nQJXmU507vFMo",
            authDomain: "unstunted-5dfce.firebaseapp.com",
            projectId: "unstunted-5dfce",
            storageBucket: "unstunted-5dfce.firebasestorage.app",
            messagingSenderId: "292728949360",
            appId: "1:292728949360:web:8745e593481da9a79542b5",
            measurementId: "G-3HLZ3Q8ZEM"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        // --- HELPERS ---
        function cleanTitle(filename) {
            let name = filename.replace(/\.(mp3|wav|flac|ogg|aif|m4a).*/gi, '');
            name = name.replace(/_/g, ' ').replace(/-/g, ' ');
            name = name.replace(/\w\S*/g, (w) => (w.replace(/^\w/, (c) => c.toUpperCase())));
            const words = name.split(/\s+/);
            if(words.length > 3) return words.slice(0, 3).join(' ');
            return name;
        }

        function getMetadata(filename) {
            const clean = cleanTitle(filename);
            let type = "SFX";
            let cat = "SFX";
            const lower = filename.toLowerCase();

            if (lower.includes("riser") || lower.includes("intro") || lower.includes("build") || lower.includes("whoosh") || lower.includes("transition") || lower.includes("swoosh") || lower.includes("reverse")) {
                cat = "Riser"; type = "SFX";
            } else if (lower.includes("music") || lower.includes("orchestra") || lower.includes("piano") || lower.includes("guitar") || lower.includes("song") || lower.includes("beat") || lower.includes("loop") || lower.includes("tekno") || lower.includes("techno") || lower.includes("melody") || lower.includes("tune") || lower.includes("rhapsody") || lower.includes("symphony") || lower.includes("midi") || lower.includes("chord")) {
                cat = "Techno"; type = "Music";
                if(lower.includes("orchestra") || lower.includes("symphony") || lower.includes("choir")) cat = "Cinematic";
                if(lower.includes("electronic") || lower.includes("synth") || lower.includes("modular") || lower.includes("glitch") || lower.includes("8-bit") || lower.includes("chip") || lower.includes("computer") || lower.includes("digital") || lower.includes("beep") || lower.includes("blip")) cat = "Electronic";
            } else if (lower.includes("nature") || lower.includes("rain") || lower.includes("wind") || lower.includes("forest") || lower.includes("water") || lower.includes("bird") || lower.includes("storm") || lower.includes("river") || lower.includes("sea") || lower.includes("thunder")) {
                cat = "Nature"; type = "SFX";
            } else if (lower.includes("zombie") || lower.includes("horror") || lower.includes("ghost") || lower.includes("scary") || lower.includes("scream") || lower.includes("monster") || lower.includes("death") || lower.includes("haunted") || lower.includes("evil") || lower.includes("pain") || lower.includes("spooky") || lower.includes("unease")) {
                cat = "Horror"; type = "SFX";
            } else if (lower.includes("space") || lower.includes("laser") || lower.includes("robot") || lower.includes("alien") || lower.includes("warp") || lower.includes("teleport") || lower.includes("scifi") || lower.includes("sci-fi") || lower.includes("hyperspace") || lower.includes("star") || lower.includes("planet") || lower.includes("galaxy") || lower.includes("futuristic") || lower.includes("cyborg") || lower.includes("droid")) {
                cat = "Sci-Fi"; type = "SFX";
            } else if (lower.includes("footstep") || lower.includes("door") || lower.includes("hit") || lower.includes("impact") || lower.includes("glass") || lower.includes("metal") || lower.includes("mechanical") || lower.includes("faucet") || lower.includes("fridge") || lower.includes("fan") || lower.includes("crash") || lower.includes("sword") || lower.includes("gun") || lower.includes("explosion") || lower.includes("break")) {
                cat = "Foley"; type = "SFX";
            } else if (lower.includes("ambience") || lower.includes("drone") || lower.includes("factory") || lower.includes("hum") || lower.includes("noise") || lower.includes("atmosphere") || lower.includes("background") || lower.includes("texture")) {
                cat = "Ambiance"; type = "SFX";
            }
            return { clean, type, cat };
        }

        // --- GLOBAL STATE ---
        let fullLibrary = []; // Will be populated by Worker

        const categoriesByType = {
            'all': ['Riser', 'Techno', 'Electronic', 'Cinematic', 'Nature', 'Horror', 'Sci-Fi', 'Foley', 'Ambiance'],
            'Music': ['Techno', 'Electronic', 'Cinematic', 'Ambiance'],
            'SFX': ['Riser', 'Nature', 'Horror', 'Sci-Fi', 'Foley', 'Ambiance']
        };

        const state = { 
            playingId: null, 
            isPlaying: false, 
            activeType: 'all', 
            activeCategory: 'all', 
            search: '', 
            user: null, 
            isSubscribed: false,
            subscriptionTier: null,
            subscriptionEnd: null
        };
        const audio = new Audio();
        
        const els = {
            list: document.getElementById('trackList'),
            subFilters: document.getElementById('subFilters'),
            playerBar: document.getElementById('playerBar'),
            pTitle: document.getElementById('pTitle'),
            pArtist: document.getElementById('pArtist'),
            mainPlayIcon: document.getElementById('mainPlayIcon'),
            timeCurrent: document.getElementById('timeCurrent'),
            timeTotal: document.getElementById('timeTotal'),
            seekBar: document.getElementById('seekBar'),
            volBar: document.getElementById('volBar'),
            searchInput: document.getElementById('searchInput'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('loginModal'),
            tierTag: document.getElementById('tierTag')
        };

        // --- DYNAMIC LOADER ---
        async function loadLibrary() {
            try {
                showToast("Connecting to cloud...");
                
                // 1. Fetch file list from Cloudflare Worker
                const response = await fetch(WORKER_URL);
                if (!response.ok) throw new Error("Worker connection failed");
                
                const remoteFilenames = await response.json();

                // 2. Map filenames to track objects
                const r2Tracks = remoteFilenames.map((filename, index) => {
                    const meta = getMetadata(filename);
                    return {
                        id: index + 100, 
                        title: meta.clean,
                        artist: "UNSTUNTED_SFX",
                        type: meta.type,
                        category: meta.cat,
                        duration: "--:--",
                        // USE encodeURI TO FIX SPACES BUT KEEP SLASHES
                        url: `${R2_PUBLIC_URL}/${encodeURI(filename)}`
                    };
                });

                // 3. REMOVED THE HARDCODED WEBFILES HERE
                // This ensures we only show files that we have permission to download (R2)
                fullLibrary = [...r2Tracks];
                
                renderList();
                preloadDurations();
                showToast(`Library Ready: ${fullLibrary.length} sounds`);

            } catch (error) {
                console.error("Library Load Error:", error);
                els.list.innerHTML = `<div style="text-align:center; padding:3rem; color: #ff3b30;">
                    <h3>Connection Error</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem;">Could not load library. Please check your Worker URL.</p>
                </div>`;
            }
        }

        // --- INITIALIZATION ---
        function init() {
            renderSubFilters();
            loadLibrary(); // <--- Now calls dynamic loader
            setupEvents();
            checkPaymentSuccess();

            auth.onAuthStateChanged(async (user) => {
                state.user = user;
                if(user) {
                    await checkSubscriptionStatus(user.uid);
                    showToast(`Welcome, ${user.displayName || 'User'}`);
                    closeModal('loginModal');
                    if(!state.isSubscribed) {
                        setTimeout(() => openModal('pricingModal'), 1500);
                    }
                } else {
                    state.isSubscribed = false;
                    state.subscriptionTier = null;
                }
                updateAuthState();
            });
        }

        async function checkSubscriptionStatus(uid) {
            try {
                const docRef = db.collection('users').doc(uid);
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    if (data.isPremium && data.subscriptionEnd > now) {
                        state.isSubscribed = true;
                        state.subscriptionTier = data.tier;
                        state.subscriptionEnd = data.subscriptionEnd;
                    } else {
                        state.isSubscribed = false;
                        state.subscriptionTier = null;
                    }
                }
            } catch (error) { console.error("Error fetching subscription:", error); }
            updateAuthState(); 
        }

        async function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        showToast("Payment Verified! Upgrading Account...");
                        try {
                            await db.collection('users').doc(user.uid).set({
                                isPremium: true,
                                tier: 'pro',
                                subscriptionEnd: Date.now() + (365 * 24 * 60 * 60 * 1000),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                            state.isSubscribed = true;
                            updateAuthState();
                            showToast("Upgrade Successful! Enjoy your downloads.");
                            window.history.replaceState({}, document.title, window.location.pathname);
                        } catch (error) { showToast("Error upgrading account."); }
                    } else {
                        showToast("Please login to claim your access.");
                        openModal('loginModal');
                    }
                });
            }
        }

        window.checkout = function(tierId) {
            if(!state.user) {
                alert("Please login first to subscribe.");
                openModal('loginModal');
                return;
            }
            const paymentLink = STRIPE_PRICES[tierId];
            if(!paymentLink || !paymentLink.startsWith('http')) {
                alert("Payment link missing.");
                return;
            }
            showToast(`Redirecting to Secure Checkout...`);
            const emailParam = `?prefilled_email=${encodeURIComponent(state.user.email)}`;
            window.location.href = paymentLink + emailParam;
        }

        window.openModal = function(id) { 
            const m = document.getElementById(id);
            if(m) m.classList.add('open'); 
        }
        window.closeModal = function(id) { 
            const m = id ? document.getElementById(id) : document.querySelector('.modal.open');
            if(m) m.classList.remove('open'); 
        }
        
        window.loginWithGoogle = function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => { showToast("Login Failed"); });
        }

        window.logout = function() {
            auth.signOut().then(() => {
                state.isSubscribed = false; 
                state.subscriptionTier = null;
                showToast("Logged Out");
            });
        }

        function updateAuthState() {
            const loginBtn = document.getElementById('loginBtn');
            const subBtn = document.getElementById('subBtn');
            const avatar = document.getElementById('avatar');
            const tierTag = document.getElementById('tierTag');

            if (state.user) {
                loginBtn.style.display = 'none';
                avatar.style.display = 'block';
                avatar.src = state.user.photoURL || "https://ui-avatars.com/api/?name=User";
                avatar.onclick = () => { if(confirm("Log out?")) logout(); };
                if (state.isSubscribed) {
                    subBtn.style.display = 'none';
                    tierTag.style.display = 'inline-block';
                    tierTag.innerText = state.subscriptionTier ? state.subscriptionTier.toUpperCase() : 'PRO';
                } else {
                    subBtn.style.display = 'flex';
                    tierTag.style.display = 'none';
                }
            } else {
                loginBtn.style.display = 'flex';
                subBtn.style.display = 'none';
                avatar.style.display = 'none';
                tierTag.style.display = 'none';
            }
            renderList();
        }

        window.updateType = function(type) {
            state.activeType = type;
            state.activeCategory = 'all';
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText.includes(type) || (type === 'all' && btn.innerText.includes('All')));
            });
            renderSubFilters();
            renderList();
        }

        window.updateCategory = function(cat) {
            state.activeCategory = cat;
            renderSubFilters();
            renderList();
        }

        function renderSubFilters() {
            els.subFilters.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = `chip ${state.activeCategory === 'all' ? 'active' : ''}`;
            allBtn.innerText = 'All Collections';
            allBtn.onclick = () => updateCategory('all');
            els.subFilters.appendChild(allBtn);

            const cats = categoriesByType[state.activeType] || [];
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `chip ${state.activeCategory === cat ? 'active' : ''}`;
                btn.innerText = cat;
                btn.onclick = () => updateCategory(cat);
                els.subFilters.appendChild(btn);
            });
        }

        function renderList() {
            els.list.innerHTML = '';
            
            // Safety check if library hasn't loaded
            if (!fullLibrary || fullLibrary.length === 0) {
                 // Loading skeleton could go here, but for now we wait
                 return;
            }

            const filtered = fullLibrary.filter(t => {
                const typeMatch = state.activeType === 'all' || t.type === state.activeType;
                const catMatch = state.activeCategory === 'all' || t.category === state.activeCategory;
                const searchMatch = t.title.toLowerCase().includes(state.search);
                return typeMatch && catMatch && searchMatch;
            });

            if(!filtered.length) {
                els.list.innerHTML = `<div style="text-align:center; padding:5rem; color:var(--text-muted);">No matching sounds in the current collection.</div>`;
                return;
            }

            filtered.forEach(t => {
                const row = document.createElement('div');
                const isCur = state.playingId === t.id;
                row.className = `track-row ${isCur && state.isPlaying ? 'playing' : ''}`;
                row.onclick = (e) => { if(!e.target.closest('button')) playTrack(t.id); };

                const playIcon = isCur && state.isPlaying 
                    ? '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' 
                    : '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';

                const isLocked = !state.user || !state.isSubscribed;
                const lockClass = isLocked ? 'locked' : '';

                row.innerHTML = `
                    <div class="col-play">
                        <button class="play-btn-small" onclick="event.stopPropagation(); playTrack(${t.id})">${playIcon}</button>
                    </div>
                    <div class="track-info">
                        <h3>${t.title}</h3>
                        <span>${t.artist}</span>
                    </div>
                    <div class="col-meta"><span class="badge">${t.category}</span></div>
                    <div class="col-meta meta" id="dur-${t.id}">${t.duration}</div>
                    <div class="visualizer">
                        ${Array.from({length: 8}).map(() => `<div class="v-bar" style="height: ${Math.floor(Math.random() * 12 + 4)}px; animation: bounce ${0.4 + Math.random()}s infinite ease-in-out alternate"></div>`).join('')}
                    </div>
                    <div class="col-action">
                        <button class="action-btn" onclick="toggleLike(this, event)" title="Favorite">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                        <button class="action-btn ${lockClass}" onclick="downloadItem('${t.url}', event)" title="Download">
                            ${isLocked ? '<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/></svg>' : '<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>'}
                        </button>
                    </div>
                `;
                els.list.appendChild(row);
            });
        }

        window.toggleLike = function(btn, e) {
            e.stopPropagation();
            btn.classList.toggle('liked');
            showToast(btn.classList.contains('liked') ? "Added to Library" : "Removed from Library");
        }

        window.downloadItem = async function(url, e) {
            e.stopPropagation();

            if(!state.user) { 
                openModal('loginModal'); 
                return; 
            }
            if(!state.isSubscribed) { 
                openModal('pricingModal'); 
                return; 
            }

            const btn = e.currentTarget;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 4v4m0 4v4"/></svg>`; 
            showToast("Preparing download...");

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                const filename = url.split('/').pop() || 'download.mp3';
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                link.parentNode.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);
                showToast("Download started!");
            } catch (error) {
                console.error("Download failed:", error);
                showToast("Download failed. Check console.");
                window.open(url, '_blank');
            } finally {
                btn.innerHTML = originalContent;
            }
        }

        function getIndex(id) { return fullLibrary.findIndex(t => t.id === id); }

        window.playNext = function() {
            if(!state.playingId) return;
            let idx = getIndex(state.playingId);
            if(idx < fullLibrary.length - 1) playTrack(fullLibrary[idx + 1].id);
            else playTrack(fullLibrary[0].id);
        }

        window.playPrev = function() {
            if(!state.playingId) return;
            let idx = getIndex(state.playingId);
            if(idx > 0) playTrack(fullLibrary[idx - 1].id);
            else playTrack(fullLibrary[fullLibrary.length - 1].id);
        }

        function playTrack(id) {
            const track = fullLibrary.find(t => t.id === id);
            if(state.playingId === id) {
                if(state.isPlaying) { audio.pause(); state.isPlaying = false; } 
                else { audio.play(); state.isPlaying = true; }
            } else {
                state.playingId = id;
                state.isPlaying = true;
                audio.src = track.url;
                audio.play().catch(e => { showToast("File unavailable"); });
                els.pTitle.innerText = track.title;
                els.pArtist.innerText = track.artist;
                els.playerBar.classList.add('active');
            }
            updateUI();
        }

        function updateUI() {
            renderList();
            const icon = state.isPlaying ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
            els.mainPlayIcon.innerHTML = icon;
        }

        function preloadDurations() {
            // Optimization: Only load metadata for first 20 tracks to save bandwidth
            fullLibrary.slice(0, 20).forEach(track => {
                if(track.url.includes('Risers/')) {
                    const tmp = new Audio(track.url);
                    tmp.addEventListener('loadedmetadata', () => {
                        const dur = tmp.duration;
                        if(isFinite(dur)) {
                            const m = Math.floor(dur/60);
                            const s = Math.floor(dur%60);
                            track.duration = `${m}:${s<10?'0':''}${s}`;
                            const el = document.getElementById(`dur-${track.id}`);
                            if(el) el.innerText = track.duration;
                        }
                    });
                }
            });
        }

        function showToast(msg) {
            els.toast.innerText = msg;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 3000);
        }

        function setupEvents() {
            audio.addEventListener('timeupdate', () => {
                if(!isNaN(audio.duration)) {
                    const pct = (audio.currentTime / audio.duration) * 100;
                    els.seekBar.value = pct;
                    const cm = Math.floor(audio.currentTime/60);
                    const cs = Math.floor(audio.currentTime%60);
                    els.timeCurrent.innerText = `${cm}:${cs<10?'0':''}${cs}`;
                    const tm = Math.floor(audio.duration/60);
                    const ts = Math.floor(audio.duration%60);
                    els.timeTotal.innerText = `${tm}:${ts<10?'0':''}${ts}`;
                }
            });
            audio.addEventListener('ended', () => { state.isPlaying = false; updateUI(); });
            els.seekBar.addEventListener('input', (e) => { audio.currentTime = (e.target.value / 100) * audio.duration; });
            els.volBar.addEventListener('input', (e) => { audio.volume = e.target.value; });
            els.searchInput.addEventListener('input', (e) => {
                state.search = e.target.value.toLowerCase();
                renderList();
            });
            document.getElementById('clearSearch').addEventListener('click', () => {
                els.searchInput.value = '';
                state.search = '';
                renderList();
            });
            document.getElementById('mainPlayBtn').addEventListener('click', () => { if(state.playingId) playTrack(state.playingId); });
            document.getElementById('themeToggle').addEventListener('click', () => {
                const html = document.documentElement;
                html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            });
        }

        init();
    </script>
</body>
</html>
