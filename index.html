<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicLibrary | Ultimate Collection</title>

    <script src="https://js.stripe.com/v3/"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-body: #fbfbfd;
            --bg-surface: #ffffff;
            --bg-surface-hover: #f5f5f7;
            --text-main: #1d1d1f;
            --text-muted: #86868b;
            --border: rgba(0,0,0,0.06);
            --accent: #0071e3;
            --accent-glow: rgba(0, 113, 227, 0.3);
            
            --nav-height: 110px;
            --radius: 14px;
            --shadow: 0 4px 20px rgba(0,0,0,0.03);
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #050505;
            --bg-surface: #141416;
            --bg-surface-hover: #1f1f22;
            --text-main: #f5f5f7;
            --text-muted: #98989d;
            --border: rgba(255,255,255,0.08);
            --accent: #2997ff;
            --accent-glow: rgba(41, 151, 255, 0.4);
            --shadow: 0 4px 30px rgba(0,0,0,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 140px;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HERO --- */
        .hero {
            height: 220px;
            background: radial-gradient(circle at top right, rgba(41, 151, 255, 0.1) 0%, transparent 40%),
                        linear-gradient(180deg, var(--bg-surface) 0%, var(--bg-body) 100%);
            display: flex; flex-direction: column; justify-content: center;
            padding: 0 2rem;
        }
        
        .brand-large {
            font-size: 3.5rem; font-weight: 800; letter-spacing: -0.04em;
            background: linear-gradient(90deg, #2997ff, #db00ff, #2997ff);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            max-width: 1200px; margin: 0 auto; width: 100%;
            animation: shine 5s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* --- STICKY NAV --- */
        .sticky-nav {
            position: sticky; top: 0;
            z-index: 100;
            background: rgba(var(--bg-body), 0.85);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        }
        
        .nav-content {
            max-width: 1200px; margin: 0 auto; padding: 0 2rem;
            display: flex; flex-direction: column; gap: 1rem;
        }

        .top-row { display: flex; justify-content: space-between; align-items: center; }

        /* Auth Buttons */
        .auth-actions { display: flex; gap: 10px; align-items: center; }
        .btn-primary {
            background: var(--text-main); color: var(--bg-body); border: none;
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: 0.2s var(--ease); display: flex; align-items: center; gap: 6px;
        }
        .btn-primary:hover { transform: scale(1.05); }
        .btn-sub { background: var(--accent); color: white; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: none; border: 2px solid var(--accent); object-fit: cover; }
        .tier-tag { font-size: 0.75rem; font-weight: bold; color: var(--accent); border: 1px solid var(--accent); padding: 2px 8px; border-radius: 12px; display: none; margin-right: 10px; }

        /* Filters */
        .type-switcher { display: inline-flex; background: var(--bg-surface); padding: 4px; border-radius: 14px; border: 1px solid var(--border); }
        .type-btn { padding: 8px 24px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .type-btn.active { background: var(--text-main); color: var(--bg-body); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .sub-filters { display: flex; gap: 0.6rem; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .sub-filters::-webkit-scrollbar { display: none; }
        .chip { padding: 0.5rem 1.2rem; border-radius: 24px; font-size: 0.85rem; font-weight: 500; background: transparent; color: var(--text-muted); border: 1px solid var(--border); cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- LIST --- */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }

        .search-wrap { margin-bottom: 2rem; position: relative; max-width: 600px; }
        .search-input { width: 100%; padding: 1rem 3rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; color: var(--text-main); font-size: 1rem; transition: 0.2s; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .search-icon { position: absolute; left: 1.2rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 20px; }
        .clear-search { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: var(--bg-surface-hover); border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); opacity: 0; pointer-events: none; transition: 0.2s; }
        .search-input:not(:placeholder-shown) ~ .clear-search { opacity: 1; pointer-events: all; }

        .track-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .track-row {
            display: grid; grid-template-columns: 60px 3fr 1fr 80px 80px 100px;
            align-items: center; background: transparent; border: 1px solid transparent;
            border-bottom: 1px solid var(--border); padding: 0.8rem 1rem; border-radius: var(--radius); cursor: pointer; transition: all 0.2s var(--ease);
        }
        .track-row:hover { background: var(--bg-surface); transform: scale(1.005); box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 1; border-color: transparent; }
        .track-row.playing { background: var(--bg-surface); border-color: var(--accent); }
        .track-row.playing h3 { color: var(--accent); }

        .play-btn-small { width: 38px; height: 38px; border-radius: 50%; background: var(--bg-surface-hover); border: 1px solid transparent; color: var(--text-main); display: flex; align-items: center; justify-content: center; transition: 0.2s; opacity: 0.7; cursor: pointer; }
        .track-row:hover .play-btn-small { opacity: 1; background: var(--text-main); color: var(--bg-body); }
        .track-row.playing .play-btn-small { opacity: 1; background: var(--accent); color: white; }

        .track-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
        .track-info span { font-size: 0.85rem; color: var(--text-muted); }
        .badge { background: var(--bg-surface-hover); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .meta { color: var(--text-muted); font-size: 0.85rem; font-variant-numeric: tabular-nums; }
        
        .col-action { display: flex; gap: 0.5rem; justify-content: flex-end; opacity: 0; transition: 0.2s; }
        .track-row:hover .col-action { opacity: 1; }
        
        .action-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .action-btn:hover { background: var(--bg-surface-hover); color: var(--text-main); }
        .action-btn.liked { color: #ff3b30; }
        
        /* Lock visual for non-subscribed */
        .action-btn.locked::after { content: "üîí"; position: absolute; font-size: 10px; bottom: -2px; right: -2px; }
        .action-btn.locked { opacity: 0.6; }

        .visualizer { display: flex; align-items: center; gap: 3px; height: 24px; opacity: 0.5; }
        .track-row.playing .visualizer { opacity: 1; }
        .v-bar { width: 3px; background: var(--text-muted); border-radius: 2px; transition: height 0.2s; }
        .track-row.playing .v-bar { background: var(--accent); animation: bounce 0.6s infinite ease-in-out alternate; }
        @keyframes bounce { 0% { height: 4px; } 100% { height: 24px; } }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(150%);
            width: 95%; max-width: 900px;
            background: rgba(20, 20, 22, 0.9); backdrop-filter: blur(50px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; padding: 1.2rem 2rem;
            display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); z-index: 500;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        [data-theme="light"] .player-bar { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); }
        .player-bar.active { transform: translateX(-50%) translateY(0); }

        .player-top { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 0.8rem; }
        .p-info { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .p-art { width: 48px; height: 48px; background: linear-gradient(135deg, #333, #111); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .p-text h4 { font-size: 1rem; margin-bottom: 3px; color: var(--text-main); }
        .p-text span { font-size: 0.85rem; color: var(--text-muted); }
        
        .p-controls { display: flex; align-items: center; gap: 1.5rem; }
        .btn-ctrl { background: none; border: none; color: var(--text-main); cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .btn-ctrl:hover { opacity: 1; transform: scale(1.1); }
        .btn-play-lg { width: 56px; height: 56px; background: var(--text-main); color: var(--bg-body); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-play-lg:hover { transform: scale(1.05); background: var(--accent); color: white; }

        .player-bottom { display: flex; align-items: center; gap: 1rem; width: 100%; }
        .time-display { font-size: 0.75rem; color: var(--text-muted); min-width: 40px; }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: var(--text-main); margin-top: -4px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--border); }
        .seek-bar { flex: 1; } 
        .vol-wrap { display: flex; align-items: center; gap: 0.5rem; width: 80px; }

        /* --- MODAL (Common) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.open { display: flex; opacity: 1; }
        
        .modal-content {
            background: var(--bg-surface); padding: 2rem; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            transform: translateY(20px); transition: transform 0.3s;
            position: relative;
        }
        .modal.open .modal-content { transform: translateY(0); }
        .modal h2 { margin-bottom: 0.5rem; }
        .modal p { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem; }
        
        .google-btn {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--bg-surface); color: var(--text-main);
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
        }
        .google-btn:hover { background: var(--bg-surface-hover); border-color: var(--text-muted); }
        .close-modal { position: absolute; top: 1rem; right: 1rem; cursor: pointer; color: var(--text-muted); font-size: 1.2rem; }

        /* --- PRICING MODAL STYLES --- */
        .modal-pricing-content { max-width: 900px; padding: 2.5rem; position: relative; }
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .price-card { border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; text-align: left; transition: 0.2s; position: relative; background: var(--bg-surface); }
        .price-card:hover { border-color: var(--accent); transform: translateY(-5px); }
        .price-card.popular { border: 2px solid var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        .pop-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .price-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .price-cost { font-size: 2rem; font-weight: 800; margin-bottom: 1rem; display: block; }
        .price-cost span { font-size: 0.9rem; font-weight: 400; color: var(--text-muted); }
        .feature-list { list-style: none; margin-bottom: 1.5rem; }
        .feature-list li { margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
        .feature-list li svg { color: var(--accent); }
        .btn-select-plan { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; background: var(--bg-surface-hover); color: var(--text-main); }
        .price-card.popular .btn-select-plan { background: var(--accent); color: white; }
        .btn-select-plan:hover { transform: scale(1.02); }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--text-main); color: var(--bg-body); padding: 10px 20px; border-radius: 30px; font-weight: 600; z-index: 3000; transition: transform 0.4s; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @media (max-width: 768px) {
            .track-row { grid-template-columns: 50px 1fr 50px; grid-template-areas: "play title action" "play meta action"; gap: 0 0.5rem; }
            .col-play { grid-area: play; } .track-info { grid-area: title; }
            .badge, .visualizer { display: none; } .col-meta { grid-area: meta; } .col-action { grid-area: action; opacity: 1; }
            .hero { height: 180px; } .brand-large { font-size: 2.2rem; }
            .vol-wrap { display: none; }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast">Welcome</div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">‚úï</span>
            <h2>Sign in to SonicLibrary</h2>
            <p>Access your pro assets, sync your favorites, and manage your subscription.</p>
            <button class="google-btn" onclick="loginWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
                Continue with Google
            </button>
        </div>
    </div>

    <div id="pricingModal" class="modal">
        <div class="modal-content modal-pricing-content">
            <span class="close-modal" onclick="closeModal('pricingModal')">‚úï</span>
            <h2>Unlock Full Access</h2>
            <p>Choose the plan that fits your creative needs.</p>
            
            <div class="pricing-grid">
                <div class="price-card">
                    <div class="price-title">Monthly</div>
                    <span class="price-cost">$3<span>/mo</span></span>
                    <ul class="feature-list">
                        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> 50 Downloads / mo</li>
                        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Standard Quality (MP3)</li>
                    </ul>
                    <button class="btn-select-plan" onclick="checkout('starter')">Choose Monthly</button>
                </div>

                <div class="price-card popular">
                    <div class="pop-badge">Most Popular</div>
                    <div class="price-title">Yearly</div>
                    <span class="price-cost">$30<span>/mo</span></span>
                    <ul class="feature-list">
                        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Unlimited Downloads</li>
                        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> High Quality (WAV)</li>
                    </ul>
                    <button class="btn-select-plan" onclick="checkout('pro')">Choose Yearly</button>
                </div>

                <div class="price-card">
                    <div class="price-title">Lifetime</div>
                    <span class="price-cost">$50<span>/mo</span></span>
                    <ul class="feature-list">
                        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Everything in Pro</li>
                        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Stem Separation</li>
                    </ul>
                    <button class="btn-select-plan" onclick="checkout('ultimate')">Choose Lifetime</button>
                </div>
            </div>
        </div>
    </div>

    <div class="hero">
        <div class="brand-large">UNSTUNTED_SFX</div>
    </div>
    <div class="sticky-nav">
        <div class="nav-content">
            <div class="top-row">
                <div class="type-switcher">
                    <button class="type-btn active" onclick="updateType('all')">All</button>
                    <button class="type-btn" onclick="updateType('Music')">Music</button>
                    <button class="type-btn" onclick="updateType('SFX')">SFX</button>
                </div>
                
                <div class="auth-actions">
                    <button class="btn-primary" id="loginBtn" onclick="openModal('loginModal')">Login</button>
                    <button class="btn-primary btn-sub" id="subBtn" onclick="openModal('pricingModal')" style="display:none;">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                        Subscribe
                    </button>
                    <span id="tierTag" class="tier-tag">FREE</span>
                    <img id="avatar" class="user-avatar" src="" alt="User" title="Click to Logout">
                    
                    <button class="play-btn-small" id="themeToggle" style="border:none; box-shadow: var(--shadow); background: var(--bg-surface);">
                        <svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29zm1.41-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.29 1.29c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.29-1.29zM7.28 17.17c-.39-.39-1.02-.39-1.41 0a.996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29z"/></svg>
                    </button>
                </div>
            </div>
            <div class="sub-filters" id="subFilters"></div>
        </div>
    </div>

    <main class="container">
        <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Search library (e.g. 'alien', 'piano')...">
            <button class="clear-search" id="clearSearch"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 19 17.59 13.41 12z"/></svg></button>
        </div>

        <div class="track-list" id="trackList"></div>
    </main>

    <div class="player-bar" id="playerBar">
        <div class="player-top">
            <div class="p-info">
                <div class="p-art"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg></div>
                <div class="p-text"><h4 id="pTitle">Select a track</h4><span id="pArtist">--</span></div>
            </div>
            <div class="p-controls">
                <button class="btn-ctrl" onclick="playPrev()" title="Previous"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-ctrl btn-play-lg" id="mainPlayBtn"><svg id="mainPlayIcon" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-ctrl" onclick="playNext()" title="Next"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            </div>
        </div>
        <div class="player-bottom">
            <span class="time-display" id="timeCurrent">0:00</span>
            <input type="range" class="seek-bar" id="seekBar" value="0" min="0" max="100">
            <span class="time-display" id="timeTotal">0:00</span>
            <div class="vol-wrap">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <input type="range" id="volBar" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
        apiKey: "AIzaSyCz9644Ha8aRtEb4aTNF6nQJXmU507vFMo",
        authDomain: "unstunted-5dfce.firebaseapp.com",
        projectId: "unstunted-5dfce",
        storageBucket: "unstunted-5dfce.firebasestorage.app",
        messagingSenderId: "292728949360",
        appId: "1:292728949360:web:8745e593481da9a79542b5",
        measurementId: "G-3HLZ3Q8ZEM"
        };
        
        // --- STRIPE LINKS (Replace these) ---
        const STRIPE_LINKS = {
            'starter': 'https://buy.stripe.com/test_14A4gBejw2SA62I6L16Zy01', 
            'pro': 'https://buy.stripe.com/test_14A4gBejw2SA62I6L16Zy01',
            'ultimate': 'https://buy.stripe.com/test_14A4gBejw2SA62I6L16Zy01'
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- HELPERS ---
        function cleanTitle(filename) {
            let name = filename.replace(/\.(mp3|wav|flac|ogg|aif|m4a).*/gi, '');
            name = name.replace(/_/g, ' ').replace(/-/g, ' ');
            name = name.replace(/\w\S*/g, (w) => (w.replace(/^\w/, (c) => c.toUpperCase())));
            const words = name.split(/\s+/);
            if(words.length > 3) return words.slice(0, 3).join(' ');
            return name;
        }

        const rawFiles = [
            "10_note_guitar_chord_arpeggios_(dissonant_and_e_major_in_harmony).mp3", "120bpm_pannaner2_tr.wav.mp3","120bpm1lambda8sd.wav.mp3","120bpm3lambda8sd.wav.mp3","120bpmmu12sd.wav.mp3","120bpmnu6sd.wav.mp3","15jun2020_modbox_sample_recording.mp3","171207ambientloop.wav.mp3","192_bpm_industrial_drum_loop_#15502_(wav).mp3","2_slick_4_u.wav.mp3","2016-10-11-dr-60-ocean_waves-edited.wav.mp3","20180426_sliding_on_wet_glass.wav.mp3","20180429_squeezing_a_big,_wet_sponge.wav.mp3","2021_cupsule_sound_1.wav.mp3","5_cell_quantussy_patch_vcv-rack.wav.mp3","547966_-_snare_metal_-_(+eq).mp3","72_bpm_industrial_horror_loop_#15476_(wav).mp3","a_double_krell.wav.mp3","a_lot_of_bleeps_bloops_blurb_in_one_file.wav.mp3","a_strange_fx_02.wav.mp3","a_strange_fx_03.wav.mp3","a4.wav.mp3","absolute_disturbance_loop.wav.mp3","accidental_acid_sounds.mp3.mp3","ahhh.wav","Alien Riser.wav","alien_ambient.mp3","alien_cackle.mp3","alien_com1.wav.mp3","alien_machinery.wav.mp3","alien_tv_transmission.wav.mp3","alien.wav.mp3","analog_delay_overdrive.mp3","angry_cat_sounds_without_any_cat_being_hurt.mp3","angry_hooded_crow_(hoodie)_(corvus_cornix).mp3","another_dark_drone.mp3","anu_crash_07.wav.mp3","ao_subtractor_snare_2_6.wav.mp3","approaching_jupiter.mp3","atlantic_spotted_dolphins_off_the_coast_of_la_gomera,_canary_islands.mp3","atmo_vocal_choir_drone_synth_dark_thriller_sad_mood_cinematic.wav.mp3","bacteria_music.mp3","Bass Dancing.wav","bass_98_gm_woodbass.mp3","bassguitar_115_c_introbass.mp3","beep-00.wav","beep-01.wav","beep-02.wav","beep-03.wav","beep-04.wav","beep-05.wav","beep-06.wav","beep-07.wav","beep-08.wav","beep-09.wav","beep-10.wav","beep-11.wav","beep-12.wav","beep-13.wav","beep-14.wav","beep-15.wav","belive.wav.mp3","bell_01.ogg","bell_02.ogg","bell_03.ogg","Big Swoosh 1.wav","big_noise.mp3","biggish_saw_synth_e_e_g_b_102_bpm-14.wav.mp3","biggish_saw_synth_e_e_g_b_102_bpm-24.wav.mp3","bike_crash_medley.wav.mp3","bird_call_-_melodic_leaf_hunter_(ffr).mp3","birdchirp.wav","birdchirp2.wav","birdchirp3.wav","birdchirp4.wav","birdchirp5.wav","Birds Singing.wav","blackend_butter_140.wav.mp3","blast.wav","blastoff.wav","blind_patching.wav.mp3","blunk.wav","bonus.wav","bottles.wav.mp3","bounce.wav","Bouncy.wav","breaking_glass_.mp3","brittle_wooden_box_landing_on_floor_2.mp3","bubbles.wav","burn_the_disco_down_130bpm.wav.mp3","bwah.wav","cant_find_a_way_so_stop.wav.mp3","Car Crash.wav","car_park_skiding_corner.wav.mp3","Cave Swoosh.wav","cave_dungeon_secret_temle.mp3","Chain Drop Riser.wav","chaostekk_i.mp3","chaostekk_ii.mp3","chill_coast_beach_birds_windy_mood_atmo_surround.wav.mp3","Chior Riser.wav","choir_aah.wav.mp3","choir.aif.mp3","Chop Swoosh.aiff","chuck_plast_23046.mp3","church_atmosphere_with_choir.mp3","clap_po-12.aif.mp3","classic_modular_synth_space_sounds_-_161125.mp3","clock_divider_as_sub_bass_generator.mp3","clock_hit.mp3","closer_to_jupiter.wav.mp3","coin_flip_ping.mp3","collect1.wav","collect2.wav","collect3.wav","collect4.wav","collect5.wav","complex_riser_3.aif.mp3","compressor_motor.wav.mp3","compute.wav","computeron.wav","continuum7radioloop344hz.wav.mp3","cough,_three_slams_and_lock.wav.mp3","crash_hit_short1.wav.mp3","crash.wav.mp3","crashing.wav.mp3","creaking_wood.mp3","creature_angry_bug_monster_fantasy_sci-fi_sfx_sound-design_foley_201203_0086.wav.mp3","creep_out.mp3","creepy_ambience_sound.mp3","creepy_traffic_cleaned_carby.wav.mp3","crunchy_noise.mp3","curtains_stretchedx10.wav.mp3","curtains_stretchedx14_octdown_eqverb.wav.mp3","cyber_dub2.mp3","cyber_escape_techno.mp3","d10_rolls.wav.mp3","dare_51_-_3_point_5_inch_disc_though_modular_synth.wav.mp3","Dark Build.wav","Dark Riser.wav","dark_alien_planet_scary_horror_atmo_amb_atmosphere_surround.wav.mp3","dark_ambience.wav.mp3","dark_atmo_thriller_factory_fantasy_horror_atmosphere.wav.mp3","dark_myst_mystery_asian_asia_oriental_sad_mood_fantasy_wind_thriller_cinematic_atmo.wav.mp3","dark_nasty_hit.mp3","dark_pulsating_vocal_suspenseful_ambient_music.mp3","dark_ship_horror_atmosphere.mp3","dark_temple.mp3","data_corruption_2.mp3","deep_house_kick_drum_2.mp3","deep_kick_solo-120.bpm.wav.mp3","deep_piano_and_ensemble_melody_-_f_dorian.wav.mp3","delays544.mp3","desecration_of_hope_(dramatic_strings).wav.mp3","digital_donut.wav.mp3","diode_chaos_-_less_activity.wav.mp3","diode_chaos_-_slow_chaos_tech.mp3","dirt_it_is.mp3","dirty_fmaj7_cycling_envelope_variations.mp3","dishes_01.ogg","dishes_02.ogg","dishes_03.ogg","dishes_04.ogg","disq508_my_shepard_tone_original.wav.mp3","dog_shih_tzu_bark_series_02.wav.mp3","dolphin_noise-.wav.mp3","dolphin_screaming_underwater_in_caribbean_sea_(mexico).mp3","door_01.ogg","door_02.ogg","door_close_01.ogg","door_close_02.ogg","door_close_03.ogg","door_close_04.ogg","door_open.ogg","Double Swoosh.wav","double_yikes_stretch.wav.mp3","dragontrance_string-loop-1b.wav.mp3","dry_controlled_explosion.mp3","dslr_camera_sounds.mp3","dt_s-noise_texture.mp3","dubby_am_chord.mp3","duduk_with_orchestra.mp3","dumping_jar_contents_in_toilet.mp3","e_on_bass_01.wav.mp3","e-guitar_2.mp3","e-tronic_clip.wav.mp3","e24.mp3.mp3","echosplosion.wav","eggs_frying_2017.wav.mp3","elacho_bass_drum.wav.mp3","elacho_snare.wav.mp3","Electricity build.wav","Electro .flac","electronic_closed_high_hat_#1.mp3","electronic_confusion.mp3","electronic_minute_354_-_simple_solo.wav.mp3","electronic_minute_355_-_genie_replicating.wav.mp3","electronic_minute_357_-_genie_techno.wav.mp3","electronic_minute_358_-_genie_exp_diotima.wav.mp3","electronic_minute_362_-_2xsqrtovca.wav.mp3","electronic_minute_363_-_rainy_day_waves.wav.mp3","electronic_minute_365_-_sunny_day_2.wav.mp3","electronic_minute_366_-_sunny_day_3.wav.mp3","electronic_minute_367_-_3_short_cycles.wav.mp3","electronic_minute_371_-_5_seconds_from_370.wav.mp3","electronic_minute_373_-_fast_modular_synth_arpeggio_loop.wav.mp3","electronic_minute_375-376-377.wav.mp3","electronic_minute_378.mp3","electronic_minute_380.mp3","electronic_minute_387_-_i_forgot.mp3","electronic_minute_390_-_loop_it.mp3","electronic_minute_391_-_time_flows.mp3","electronic_minute_392_-_out_of_frustration_noodle.wav.mp3","electronic_minute_394_-_5_4_and_diss.mp3","electronic_minute_397_-_out_of_phase.mp3","electronic_minute_397_-_slow_ring_mod_seq.mp3","electronic_minute_398_-_ode_to_east.mp3","electronic_minute_398_-_ringmoddronetech.mp3","electronic_minute_399_-_hidden_for_you.mp3","electronic_minute_404_-_long_nonsensical_loop_2.mp3","electronic_minute_405_-_84hp.mp3","electronic_minute_409_-_horror_suspense_loop.wav.mp3","electronic_minute_415_-_suspense_music_vcv-rack.wav.mp3","electronic_minute_422_-_delayed_voices.mp3","electronic_minute_424_-_first_use.mp3","electronic_minute_428_-_soft_simple_ambient_music.mp3","electronic_minute_no_1.wav.mp3","electronic_minute_no_2.wav.mp3","electronic_minute_no_20_-_jupiter_storm_percussion_sounds.wav.mp3","electronic_minute_no_204_-_modular_synth_wiggle_mayhem.wav.mp3","electronic_minute_no_209_-_first_modular_synth_wiggle_2019.wav.mp3","electronic_minute_no_21_-_jupiter_storm_percussion_sounds_some_quick_changes.wav.mp3","electronic_minute_no_215_-_intermission_swoosh.wav.mp3","electronic_minute_no_216_-_intermission_acid.wav.mp3","electronic_minute_no_22_-_analog_modular_synth_groove_for_st_olympias.wav.mp3","electronic_minute_no_224_-_3rd_after_13_drone.wav.mp3","electronic_minute_no_225_-_rhythmic_thoughts.wav.mp3","electronic_minute_no_24_-_quality_evaluation.wav.mp3","electronic_minute_no_240_-_soft_ebm_beat.wav.mp3","electronic_minute_no_247_-_more_ants.mp3.mp3","electronic_minute_no_248_-_warped_kyrie.wav.mp3","electronic_minute_no_249_-_deep_space_kyrie.wav.mp3","electronic_minute_no_25_-_beware_of_the_vactrol.wav.mp3","electronic_minute_no_253_-_407072_remix_test.wav.mp3","electronic_minute_no_254_-_using_465286_in_phonogene.wav.mp3","electronic_minute_no_255_-_using_465286_in_phonogene_ii.wav.mp3","electronic_minute_no_257_-_some_flute_maybe.wav.mp3","electronic_minute_no_258_-_ambient_music_with_phonogene.wav.mp3","electronic_minute_no_262_-_cinematic_doomsday_drone.wav.mp3","electronic_minute_no_265_-_generated_drone_190429_2.wav.mp3","electronic_minute_no_271_-_water_in_space.wav.mp3","electronic_minute_no_278_-_clean_techno_beat_w_home_made_high_hat.wav.mp3","electronic_minute_no_284_-_bartonmusicalcircuits_2lfosh_(bmc_017).wav.mp3","electronic_minute_no_29_-_between_space.wav.mp3","electronic_minute_no_291_-_smaller_better_weirder.wav.mp3","electronic_minute_no_293_-_strange_modular_explorations_in_mono.wav.mp3","electronic_minute_no_296_-_bubbly_chaos.wav.mp3","electronic_minute_no_306_-_chaotic_noise_glitch.wav.mp3","electronic_minute_no_31_-_scales_with_fnatt.wav.mp3","electronic_minute_no_310_-_mathematical_division_2.wav.mp3","electronic_minute_no_311_-_mathematical_division_3.wav.mp3","electronic_minute_no_316_-_mission_accomplished.wav.mp3","electronic_minute_no_319_-_feedback_is_art.wav.mp3","electronic_minute_no_31b_-_full_modular_acid_remix.mp3.mp3","electronic_minute_no_320_-_explores_relationships.wav.mp3","electronic_minute_no_321_-_explores_relationships_variation.wav.mp3","electronic_minute_no_323_-_random_bleeps_and_bloops.wav.mp3","electronic_minute_no_324_-_taking_over_chaos.wav.mp3","electronic_minute_no_33_-_start_with_chaos.wav.mp3","electronic_minute_no_333_-_vcv-rack_quantussy_cheating.wav.mp3","electronic_minute_no_334_-_krellpatch_54s.wav.mp3","electronic_minute_no_335_-_krellogy_i.wav.mp3","electronic_minute_no_336_-_krellogy_ii.wav.mp3","electronic_minute_no_34_-_how_did_i_do_it.wav.mp3","electronic_minute_no_340_-_some_fm_maybe.wav.mp3","electronic_minute_no_341_-_east_and_west.wav.mp3","electronic_minute_no_345_-_enter_the_engine_room.wav.mp3","electronic_minute_no_349_-_348_processed.wav.mp3","electronic_minute_no_352_-_running_in_fear.wav.mp3","electronic_minute_no_39_-_q_relative.wav.mp3","electronic_minute_no_4.wav.mp3","electronic_minute_no_40_-_drums_of_doom.wav.mp3","electronic_minute_no_44_-_chain_reaction.wav.mp3","electronic_minute_no_46_-_soon_five.wav.mp3","electronic_minute_no_50_-leaving_equilibrium.wav.mp3","electronic_minute_no_52_-_do_you_hear_a_pattern.wav.mp3","electronic_minute_no_55_-_3_cells_(vcv-rack).wav.mp3","electronic_minute_no_55_-_minimal_but_moving.wav.mp3","electronic_minute_no_56_-_random_and_a_bad_delay.wav.mp3","electronic_minute_no_58_-_more_looping_envelopes.wav.mp3","electronic_minute_no_59_-_delay_more.wav.mp3","electronic_minute_no_6.wav.mp3","electronic_minute_no_60_-_rumble.wav.mp3","electronic_minute_no_61_-_filter_sounds.wav.mp3","electronic_minute_no_62_-_no_excuse.wav.mp3","electronic_minute_no_66_-_insekter.wav.mp3","electronic_minute_no_68_-_yvig.wav.mp3","electronic_minute_no_69_-_galen.wav.mp3","electronic_minute_no_70_-_fr√•n_samma_inspelning_som_galen.wav.mp3","electronic_minute_no_71_-_en_osc_ett_vcf_en_timme_(mp3).mp3.mp3","electronic_minute_no_73_-_dramatic_strange_loop.wav.mp3","electronic_minute_no_75_-_d√§r_stenar_rullar.wav.mp3","electronic_minute_no_79_-_eternal_tension_variations.wav.mp3","electronic_minute_no_80_-_interference.wav.mp3","emotional_pop_guitar_loop_3_[normal]_[93bpm]_[e_minor].mp3","Empty Swoosh.wav","Energy Bounce.wav","etheral_chip_beat.mp3","ethno_folk_accoustic_dark_horror_experimental_thriller_sad_mood_music_atmo_ambience_cinematic_film_movie_131bpm_surround.wav.mp3","ethno_folk_vocal_africa_arfican_afro_woman_chill_relx_atmo_soundscape_cinematic_surround.wav.mp3","ethno_folk_voices_woman_vocal_atmo_african_chill_relax_atmo_cinematic_film_movie.wav.mp3","experimental_session.wav.mp3","explodify.wav","explodify2.wav","explodify3.wav","explodify4.wav","explodify5.wav","explosion.ogg","Explosion.wav","explosion.wav.mp3","Explosive.wav","f_and_quint_loop.wav.mp3","face_the_dance_130_bpm.wav.mp3","fail.wav","fan_motor.mp3","fart_sound_50.mp3","Fast Whoosh.flac","fast_warp_in.mp3","faucet_+_sink_+_drain_gurgling.mp3","faucet_leak_shift.mp3","Fear Riser.wav","ff_chaos_techno_1.wav.mp3","FF_punch.wav","Fiery Explosion.wav","find_your_loop_in_the_land_of_random.mp3","fire_flame_burner.mp3","Firecracker Explosion.flac","five_modular_minutes.wav.mp3","floor_tom_po-12.aif.mp3","flump.wav","fly_in.wav.mp3","flying_tv-0_buzzing_fly.aiff.mp3","fm_noise_with_some_rhythm.wav.mp3","foley_bullet_hit_metal.wav.mp3","footsteps_boots_tile_mono.wav.mp3","footsteps_in_a_concrete_corridor_1.mp3","footsteps_metallic_muffled_louder.wav.mp3","footsteps_on_concrete.mp3","freakystien.wav.mp3","fridge_sfx.mp3","fried_twinkie.wav.mp3","from_my_home_2_you.wav.mp3","frominside_pad_loop_c_4s.wav.mp3","fun_spins_01.varispeed_*_2.24.wav.mp3","funny_whoop_cartoon_sounds.mp3","g12-15-dolphins_underwater.wav.mp3","Gamify.wav","general_midi_ambient_fl-20.mp3","ghosts_moaning.wav.mp3","giant_killer_rat_howls.ogg.mp3","gibberish_1.mp3.mp3","glass_-_singing_wine_glass_-_full_01.wav.mp3","glass_-_singing_wine_glass_-_full_02.wav.mp3","glass_01.ogg","glass_02.ogg","glass_03.ogg","glass_04.ogg","glass_05.ogg","glass_aquaphone_drone_2.mp3","glassding44-24b.wav.mp3","glitch_rock_loop.wav.mp3","glitchbuzz3.wav.mp3","glitched_darbuka_made_with_samsara.wav.mp3","glowing_pad.wav.mp3","gnome_surprise.wav.mp3","golden.wav.mp3","gong_01.ogg","gong_02.ogg","gong.aif.mp3","grogurgle.wav.mp3","gross_beat.wav.mp3","grunt2_-_death_pain.wav.mp3","gtr.wav.mp3","guitar_beat_thing.mp3","guitar_psychosis.mp3","hair_dryer.mp3","hardsyncandsquarewaves.wav.mp3","harsh_analog_fm_radio_flips_3.mp3","haunted_old_factory_atmo_-_mastered.wav.mp3","haunting_music_1.wav.mp3","hi-hat_closed_po-12.aif.mp3","hi-hat_open_po-12.aif.mp3","hi-strings-4notes.mp3","hihat_acccent1jazzy1.wav.mp3","hit_01.ogg","hit_02.ogg","hit_03.ogg","hit_04.ogg","hit1.wav","hit2.wav","hit3.wav","hitting_metal_pole.mp3","hop.wav","Horror Violin.mp3","horror_chase_song,_slow_(120_bpm)_then_fast_(145_bpm)_and_ends_slow_again.mp3","house_bedroom_door_2.wav.mp3","howling_distorting_feedback_patch.wav.mp3","huge_explosion.mp3","huge_impact_#2.mp3","hyperspace.wav.mp3","i_am_the_harbinger_of_your_doom.mp3","i_have_got_a_sequencer_-_first_test_-_loop.wav.mp3","if_you_dont_know_-_krell_and_chaos_(mono).wav.mp3","Impact Riser.wav","impact_sfx_028.wav.mp3","in_between_there_is_silence.mp3","inn_or_tavern_keeper_lines_male_2.mp3","intersymmetric-xyz_room_code_hi_from_sweden(220407).wav.mp3","intro.mp3","its_easy_(tomentum+_remix).mp3","Jet Engine Swoosh.wav","jews_harp_from_hell.wav.mp3","juicy_124_g.wav.mp3","jump.wav","jungle_tribal_hut_-_jungle_cinematic_tribal_drums_cajon_synth_atmo_music_background_drama.wav.mp3","key_open_01.ogg","key_open_02.ogg","keyboard_4.wav.mp3","kick_natural1.wav.mp3","kick_natural2.wav.mp3","kick_po-12.aif.mp3","kinda_vocoder_physical_modelling_mic_02.wav.mp3","kittens_from_hell.mp3","la-a.m4a.mp3","laffik_pol_pola≈Ñski.wav.mp3","laser.wav","laser2.wav","laser3.wav","laser4.wav","lawnmower.wav.mp3","lfo_controlled_amplitude_experiment.mp3.mp3","light_in_the_void.mp3","light_wooshes.mp3","lilu_bb.mp3","limited_feedback.wav.mp3","logistische_gleichung_longer_session.wav.mp3","long_modular_christmas_drone.wav.mp3","low_slow_metal.mp3","lyrics544.mp3","machine_01.ogg","machine_02.ogg","machine_03.ogg","machinery_hum.mp3","mad_flanger.mp3","magpies_of_december_etc.wav.mp3","male_grunting_in_pain.mp3","male_scream_pain_torture.wav.mp3","many_bird_tree.mp3","massive_zebra_drone.mp3","mechanical_dreams.mp3","mechanical_machinery_3.mp3","mechanical_machinery_technology.mp3","mechanical_machinery.mp3","mechanical_sfx_m001.wav.mp3","medieval_music_by_sj√§l_on_hunehals_borg.mp3.mp3","metal_01.ogg","metal_02.ogg","metal_03.ogg","metal_04.ogg","metal_05.ogg","metal_06.ogg","metal_07.ogg","metal_08.ogg","metal_09.ogg","metal_10.ogg","metal_11.ogg","metal_12.ogg","metal_bucket_hit_reverb.wav.mp3","metal_impact.mp3","metal_sfx_&_foley,_metal_dings_with_reverb.wav.mp3","metal_water_pan.mp3","metallic_hits,_strings,_inside_piano,_sequence_2.mp3","metallic_sound_with_drum_stick.wav.mp3","meteor_flyby.mp3","microwave_door_close.ogg","microwave_door_open.ogg","mister_bubble_130_dm.wav.mp3","modified_doepfer_a-124_vcf5_wasp_filter.wav.mp3","modular_filter_work-out.wav.mp3","modular_space_sounds_161229.mp3","modular_synth_fm-modulation_mayhem_drone.wav.mp3","modular_synth_sequence_with_character_1.wav.mp3","modular_synth_thru_guitar_amp.wav.mp3","modularbreath.wav.mp3","monster_roar.mp3","monster_sound_effects_6.wav.mp3","monster_water_whirl_lofi.wav.mp3","monster.wav.mp3","mostly_empty_soda_can_playing.wav.mp3","mother_ship.wav.mp3","move.wav","musical_composition.mp3","myst_jungle_tribal_dark_thriller_vocal_atmo_woman_men_animals_birds_drone_cinematic_surround.wav.mp3","nasty_110_d.wav.mp3","Nature Walk.wav","neon-colored_palm.mp3","new_language_011.wav.mp3","noise_01.ogg","noise_02.ogg","noise544.mp3","not_random_but_chaos.mp3","obdulalongatta.wav.mp3","oceanwave1.wav","oceanwave2.wav","oceanwave3.wav","oceanwave4.wav","oceanwave5.wav","offbalance.wav","old_spaceship_engine_room_ambience.wav.mp3","ominus.wav.mp3","omnitech_140.wav.mp3","on_the_sreet_130.wav.mp3","one_lfo_controlling_pitch_spread_and_vcf_with_vca.mp3","orchestal_music_game.mp3","other_01.ogg","other_02.ogg","other_03.ogg","other_04.ogg","other_05.ogg","other_06.ogg","other_07.ogg","ouch.wav","outside_my_door_-_iphone_5_recording_25th_of_may_2017.wav.mp3","paper_01.ogg","paper_02.ogg","paper_03.ogg","paper_04.ogg","past_illusions_(ambient).mp3","patch_with_dynamics_and_variation.wav.mp3","patch1-merge.wav.mp3","paulstretch_of_atonal_modular_sound.mp3","penelope_1.mp3","penelope_2.mp3","phrygian_fog.mp3","piano_keys_vibration.mp3.mp3","piano_loops_154_efect_2_octave_long_loop_120_bpm.mp3","playful_modular_sounds.wav.mp3","plop_01.ogg","plop_02.ogg","plop.wav","plukin2.wav.mp3","plukstrn.wav.mp3","pot_01.ogg","pot_02.ogg","power_pluckin.wav.mp3","powerful_crush.mp3","Powerup.wav","Powerup2.wav","presence_-_sci-fi.mp3","processed_422056_toiletrolltube_reverb.wav.mp3","pulsating_vibrating_shortwave_radio_noise.mp3","pump_the_bump.wav.mp3","punch.wav","purpose_ii.mp3","Quick Swoosh 001.wav","Quiet Swoosh.wav","r2d2.wav","radio_fm_search_tuning_whistling_pulsating.mp3","rainfall.mp3","random_generic_sci-fi_ambience.mp3","random_melody_from_doepfer_site.mp3","rave_tunes_102_bpm-19.wav.mp3","rebound_thunder.wav.mp3","recurrent_sound_in_my_life_487.mp3","reflect.wav","resolve.wav.mp3","retarded_laugh.mp3","rev_cymb_18.wav.mp3","reverb_house_beat_116bpm_with.wav.mp3","reverb_short_house_beat_116bpm_with-02.wav.mp3","Reverse Swoosh.wav","reverse_phase_quantum.wav.mp3","riser hit.wav","river_death.wav.mp3","robo_bird.wav.mp3","robot_undergoing_analysis_24bit_48khz.wav.mp3","rock_seq_170.wav.mp3","Rocket Launch.wav","rolling_tense_cinematic_pondering_bass_loop.mp3","rooftop_rhapsody.mp3","room_musik99_220407_1945.mp3","roughsea.wav.mp3","rubber_band_140.wav.mp3","rustle01.flac","rustle02.flac","rustle03.flac","s10-10_metal_objects_hitting_and_fall.wav.mp3","s10-17_small_metal_and_glass_objects_fall_onto_hard_floor.wav.mp3","s16-18_tesla_coil_sparking_and_humming.wav.mp3","s21-28_slow_river;_small_water_movement.wav.mp3","s21-29_swimming_in_pool.wav.mp3","s23-22_arrows_fly_&_hit;_indoors.wav.mp3","s24-22_blacksmith_hitting_anvil_with_hammer;_two_versions.wav.mp3","s26-03_respirator;_loopable.wav.mp3","s27-06_panther_and_wild_boar_fight.wav.mp3","s27-12_mastodon_growls;_dinosaur.wav.mp3","s27-29_chimpanzee_whimper_and_scream.wav.mp3","s28-33_bees_swarming.wav.mp3","s29-18_boat_creaking;_moving_against_dock.wav.mp3","s31-29_wild_men_growl_and_fight.wav.mp3","s34-15_two_dragons_scream.wav.mp3","s34-18_large_spring_snaps_with_a_twang.wav.mp3","s34-25_loud_diesel_small_truck_enters_and_crashes_through_fence.wav.mp3","s34-28_submarine_propeller_under_water.wav.mp3","s37-14_two_cars_crash_foley;_good_metallic_bump.wav.mp3","s38-01_man_eaten_by_alligator;_screams_[wilhelm_screams].wav.mp3","s38-22_background_ominous_rumble;_loopable.wav.mp3","s38-27_crazy_machine_sound_from_warner_brothers;_loopable.wav.mp3","s40-05_computer_overload_&_fail.wav.mp3","s41-21_spooky_singing_ghost_wind.wav.mp3","sad_alone_orchestra_strings_drama_music_mood_surround.wav.mp3","sameba_kids_choir_-_2.wav.mp3","sample_for_phonogene_-_a_mix_of_321731_81737_49435.wav.mp3","scambling_eggs.mp3","scary_ambience_skeletons.mp3","scary_drone.wav.mp3","sci-fi_fx_compilation.wav.mp3","scifi_hit_thing_3.wav.mp3","scifi_microbrute_02.mp3","scifi_microbrute_03.mp3","scifi_microbrute_13.mp3","scifi_microbrute_16.mp3","scifi_synth_drone_306f.mp3","selected_frequencies_3_vcv-rack.mp3","selected_frequencies_vcv-rack.mp3","shaped_by_chaos.mp3","Shaving Cream.wav","shhhh_an_alien_bird.wav.mp3","shimmer-guitar.wav.mp3","shot_01.ogg","shot_02.ogg","shower_running.mp3","sibling_drone_2.wav.mp3","sibling_drone_3.wav.mp3","silent_spring.wav.mp3","slam_01.ogg","slam_02.ogg","slam_03.ogg","slam_04.ogg","slam_05.ogg","slam_06.ogg","slam_07.ogg","slap.wav","small_fireworks_-_happy_new_year_2018.wav.mp3","small_three_lfo_patch.wav.mp3","Soft Wind.mp3","soft_friday_drone.wav.mp3","somebeat210308loop.wav.mp3","sonic_debris.wav.mp3","sorry,_im_a_bit_late.wav.mp3","Sound of the Echo.wav","sound_strobe.mp3","sounds_crazy.wav.mp3","Space Station.mp3","space_hole_test.wav.mp3","space_pirates.mp3","spacehole_exploration.mp3","spanish-carnival-choir.wav.mp3","spectral_fragment_of_speech.mp3","spin1.wav.mp3","spinning_toss.wav","spirits_moving.wav.mp3","splash_01.ogg","splash_02.ogg","splash.wav","spooky_metallic_sound.mp3","spring_01.ogg","spring_02.ogg","spring_03.ogg","spring_04.ogg","spring_05.ogg","spring_06.ogg","spring_07.ogg","spring_08.ogg","spring_09.ogg","spring1.wav","spring2.wav","spring3.wav","spring4.wav","sputter.wav.mp3","Sqeeky Clean.mp3","square_wave_techno_terror.wav.mp3","static_cu_min_yo.mp3","steamwhistle_0.wav","stekachampinjonerljudavfl√§kt_gis_sweden_140512.wav.mp3","stereo_city_garden_rain.mp3","stereo_dub_fx_150_bpm.wav.mp3","stereo_sub_crossfade_b.wav.mp3","stone_photo-2-sound.wav.mp3","storm_eunice_from_open_window_with_rattling_fluttering_roof_foil.wav.mp3","storm_noise.mp3","strange_planet.mp3","string_delay.mp3","string_organ_build_up.mp3","string_pizzicato.mp3","string_slap_2.mp3","string.wav","struggle.wav","sub_oceano_a.wav.mp3","suddenly_you_realize.wav.mp3","Suspence & Whoosh.wav","switch_01.ogg","switch_02.ogg","swoosh_4.wav.mp3","Swoosh.wav","sword_drawn.mp3","symphony_of_shadows.mp3","synthetic_guitar_pluck_(180_bpm).mp3","synthetic_unease.mp3","synthsound_3_horror.wav.mp3","system_of_lies.wav.mp3","system_shutdown.mp3","taming_random_in_two_ways.mp3","tapping_sound.mp3","taunt_(robotic_voice).mp3","techno_retro_trance_sample_short_cinematic_120bpm_music_surround.wav.mp3","tekbeat_140.wav.mp3","tekno001.mp3","tekno003.mp3","tekno004.mp3","tekno007s.mp3","teknoloop002.mp3","telephone.wav","teleport_sound.mp3","Tennis Swoosh.wav","texure_version_of_stupid_chase_-_could_be_useful.wav.mp3","tg92n02s808n04.flac.mp3","tgrowl.wav.mp3","The Cut Off.wav","The Intro.wav","The Wait.wav","the_abyss.mp3","the_edge.wav.mp3","the_kind_of_blips_you_hate.wav.mp3","the_last_ocean_loop.wav.mp3","the_mirror.mp3","the_song_stranglehold_+_smoking_reefer.mp3","the_voice.wav.mp3","thecno3chord_140bpm.wav.mp3","ThunderStorm.wav","tinitus_de_luxe_-_modular_noise.wav.mp3","tinyexplode.wav","tinywarble.wav","toilet_01.ogg","toilet_02.ogg","tom_high_1980s_huge_reverb.wav.mp3","tools_01.ogg","tools_02.ogg","tools_03.ogg","tools_04.ogg","tools_05.ogg","toru≈Ñski_ambient.mp3","toxin.wav.mp3","train_upon_us.wav.mp3","transform.wav","transform2.wav","trembling_low_frequency_rumble.mp3","tribe_drum_loop.mp3","true_to_the_patch_-_divide_by_64.wav.mp3","two_voices_caught_in_a_chaotic_feedback_patch.wav.mp3","un_poco_de_chile_130_bpm.wav.mp3","unclear_message_in_ship_station.wav.mp3","unreal_whispers.mp3","uoki-toki_polivoks_vcf_fully_patched_for_noise.wav.mp3","value_57.mp3","value_67.mp3","vcf_practice_and_a_bass_drum.wav.mp3","vcv_modular_experiments_(sychomancer_test)_.wav.mp3","vcv_rack_jam_#1.wav.mp3","vcv-rack_my_radio_patch_-_take_1.wav.mp3","vcvradio220421.mp3","very_very_electronic_beat_in_c.wav.mp3","video_game_warrior_134_am.wav.mp3","vidsyn_oct2011_pastisch_1.wav.mp3","virus_saturday_disco.mp3","voice_saying_techno.mp3","vy_zat_vas_krazy.mp3","wacky_laugh.mp3","walking_on_sand_and_gravel.mp3","war_of_the_worlds_horn_1.wav.mp3","warp_drive_initiate.mp3","water_splash,_emptying_a_bucket_2.mp3","water_splashing.mp3","Wave Swoosh.wav","websdr_shannon_volmet_weather_report_13264.0khz.mp3","weird_01.ogg","weird_02.ogg","weird_03.ogg","weird_04.ogg","weird_05.ogg","what_am_i_doing.wav.mp3","what_it_is.mp3","when_not_in_control_time_stretch_of_very_small_part_(a_swoosh).mp3","whimper.wav","Whip Swoosh 2.wav","Whip Swoosh.wav","whisper_evil_little_nothings_to_me.mp3","whispering_man.mp3","whistle_cab.wav","whistle_wolf.wav","whistle.wav","whistle2.wav","whistle3.wav","who_done_it.mp3","whoosh.mp3","wide_open.wav.mp3","wilder_thoughts_e-guitar_(123_bpm).wav.mp3","wind_from_chaos_no_1.wav.mp3","wind.ogg.mp3","wineglass_04.wav.mp3","wobbledown.wav","wobbledown2.wav","wobbleup.wav","wobbleup2.wav","woman_insane_laughter.mp3","wood_milling_a_door_and_vacuum_cleaning.m4a.mp3","wooded_box_open.ogg","wooden_01.ogg","wooden_02.ogg","wooden_03.ogg","working_on_my_reverb_soundscape.mp3","wow_siren.wav.mp3","wrong_answer_01.mp3","xmgb3_(cross_modulated_ghost_bell_3).mp3","you_are_sooo_zapped.wav.mp3","zombie_growl_3.wav.mp3","zombie_pain_6.wav.mp3","zombie_vocals_2.mp3","zombie_vocals.mp3"
        ];

        const library = rawFiles.map((filename, index) => {
            const clean = cleanTitle(filename);
            let type = "SFX";
            let cat = "SFX";

            const lower = filename.toLowerCase();
            // Categorization Rule Engine
            if (lower.includes("riser") || lower.includes("intro") || lower.includes("build") || lower.includes("whoosh") || lower.includes("transition") || lower.includes("swoosh") || lower.includes("reverse")) {
                cat = "Riser"; type = "SFX";
            } else if (lower.includes("music") || lower.includes("orchestra") || lower.includes("piano") || lower.includes("guitar") || lower.includes("song") || lower.includes("beat") || lower.includes("loop") || lower.includes("tekno") || lower.includes("techno") || lower.includes("melody") || lower.includes("tune") || lower.includes("rhapsody") || lower.includes("symphony") || lower.includes("midi") || lower.includes("chord")) {
                cat = "Techno"; type = "Music";
                if(lower.includes("orchestra") || lower.includes("symphony") || lower.includes("choir")) cat = "Cinematic";
            } else if (lower.includes("nature") || lower.includes("rain") || lower.includes("wind") || lower.includes("forest") || lower.includes("water") || lower.includes("bird") || lower.includes("storm") || lower.includes("river") || lower.includes("sea") || lower.includes("thunder")) {
                cat = "Nature"; type = "SFX";
            } else if (lower.includes("zombie") || lower.includes("horror") || lower.includes("ghost") || lower.includes("scary") || lower.includes("scream") || lower.includes("monster") || lower.includes("death") || lower.includes("haunted") || lower.includes("evil") || lower.includes("pain") || lower.includes("spooky") || lower.includes("unease")) {
                cat = "Horror"; type = "SFX";
            } else if (lower.includes("space") || lower.includes("laser") || lower.includes("robot") || lower.includes("alien") || lower.includes("warp") || lower.includes("teleport") || lower.includes("scifi") || lower.includes("sci-fi") || lower.includes("hyperspace") || lower.includes("star") || lower.includes("planet") || lower.includes("galaxy") || lower.includes("futuristic") || lower.includes("cyborg") || lower.includes("droid")) {
                cat = "Sci-Fi"; type = "SFX";
            } else if (lower.includes("footstep") || lower.includes("door") || lower.includes("hit") || lower.includes("impact") || lower.includes("glass") || lower.includes("metal") || lower.includes("mechanical") || lower.includes("faucet") || lower.includes("fridge") || lower.includes("fan") || lower.includes("crash") || lower.includes("sword") || lower.includes("gun") || lower.includes("explosion") || lower.includes("break")) {
                cat = "Foley"; type = "SFX";
            } else if (lower.includes("ambience") || lower.includes("drone") || lower.includes("factory") || lower.includes("hum") || lower.includes("noise") || lower.includes("atmosphere") || lower.includes("background") || lower.includes("texture")) {
                cat = "Ambiance"; type = "SFX";
            } else if (lower.includes("electronic") || lower.includes("synth") || lower.includes("modular") || lower.includes("glitch") || lower.includes("8-bit") || lower.includes("chip") || lower.includes("computer") || lower.includes("digital") || lower.includes("beep") || lower.includes("blip")) {
                cat = "Electronic"; type = "Music";
            }

            return {
                id: index + 100,
                title: clean,
                artist: "Local Library",
                type: type,
                category: cat,
                duration: "--:--",
                url: `Risers/${filename}`
            };
        });

        const webFiles = [
             { id: 1, title: "Uplifting Tech Bed", artist: "Corporate Music", type: "Music", category: "Electronic", duration: "2:10", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
             { id: 2, title: "Lo-Fi Study Beat", artist: "Chillhop", type: "Music", category: "Electronic", duration: "1:30", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3" }
        ];
        
        const fullLibrary = [...webFiles, ...library];

        const categoriesByType = {
            'all': ['Riser', 'Techno', 'Electronic', 'Cinematic', 'Nature', 'Horror', 'Sci-Fi', 'Foley', 'Ambiance'],
            'Music': ['Techno', 'Electronic', 'Cinematic', 'Ambiance'],
            'SFX': ['Riser', 'Nature', 'Horror', 'Sci-Fi', 'Foley', 'Ambiance']
        };

        const state = { 
            playingId: null, 
            isPlaying: false, 
            activeType: 'all', 
            activeCategory: 'all', 
            search: '', 
            user: null, 
            isSubscribed: false,
            subscriptionTier: null,
            subscriptionEnd: null
        };
        const audio = new Audio();
        
        const els = {
            list: document.getElementById('trackList'),
            subFilters: document.getElementById('subFilters'),
            playerBar: document.getElementById('playerBar'),
            pTitle: document.getElementById('pTitle'),
            pArtist: document.getElementById('pArtist'),
            mainPlayIcon: document.getElementById('mainPlayIcon'),
            timeCurrent: document.getElementById('timeCurrent'),
            timeTotal: document.getElementById('timeTotal'),
            seekBar: document.getElementById('seekBar'),
            volBar: document.getElementById('volBar'),
            searchInput: document.getElementById('searchInput'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('loginModal'),
            tierTag: document.getElementById('tierTag')
        };

        function init() {
            renderSubFilters();
            renderList();
            setupEvents();
            preloadDurations();

            // 1. Check for Stripe Success Return
            checkPaymentSuccess();

            // 2. Listen for Auth State Changes
            auth.onAuthStateChanged(async (user) => {
                state.user = user;
                if(user) {
                    await checkSubscriptionStatus(user.uid);
                    showToast(`Welcome, ${user.displayName || 'User'}`);
                    closeModal('loginModal');
                    
                    if(!state.isSubscribed) {
                        // Open pricing if not subscribed after login
                        setTimeout(() => openModal('pricingModal'), 1500);
                    }
                } else {
                    state.isSubscribed = false;
                    state.subscriptionTier = null;
                }
                updateAuthState();
            });
        }

        // --- 2. FIRESTORE & AUTH LOGIC ---

        // Check user's subscription in Firestore
        async function checkSubscriptionStatus(uid) {
            try {
                const docRef = db.collection('users').doc(uid);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    // Logic: Is there a subscription and has it not expired?
                    if (data.isPremium && data.subscriptionEnd > now) {
                        state.isSubscribed = true;
                        state.subscriptionTier = data.tier;
                        state.subscriptionEnd = data.subscriptionEnd;
                        console.log(`User has active ${data.tier} subscription until ${new Date(data.subscriptionEnd)}`);
                    } else {
                        state.isSubscribed = false;
                        state.subscriptionTier = null;
                    }
                }
            } catch (error) {
                console.error("Error fetching subscription:", error);
            }
            updateAuthState(); // Update UI based on new state
        }

        // Handle return from Stripe (Successful Payment)
        async function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            // Stripe adds ?success=true or session_id if configured
            if (urlParams.get('success') === 'true' && auth.currentUser) {
                
                showToast("Verifying Payment...");
                
                // --- SECURITY WARNING ---
                // In a REAL app, this update happens via Stripe Webhook -> Cloud Function.
                // Updating this client-side is insecure but functional for this demo.
                
                const uid = auth.currentUser.uid;
                // Default to 'pro' if we can't track exactly which button was clicked in this simple demo
                // You can store 'pendingTier' in localStorage before redirect to be more accurate
                const tier = localStorage.getItem('pendingTier') || 'pro'; 
                
                // Grant 30 days access
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const expiration = Date.now() + thirtyDays;

                await db.collection('users').doc(uid).set({
                    isPremium: true,
                    tier: tier,
                    subscriptionEnd: expiration,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                state.isSubscribed = true;
                state.subscriptionTier = tier;
                
                showToast("Subscription Activated!");
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                updateAuthState();
            }
        }

        // --- 3. CHECKOUT FUNCTION ---
        window.checkout = async function(tierId) {
            if(!state.user) {
                alert("Please login first to subscribe.");
                openModal('loginModal');
                return;
            }

            const link = STRIPE_LINKS[tierId];
            if(!link || link.includes('REPLACE')) {
                alert("Please configure your Stripe Link IDs in the code first.");
                return;
            }

            // Save the tier they are trying to buy to localStorage so we know what to give them on return
            localStorage.setItem('pendingTier', tierId);

            showToast(`Redirecting to ${tierId} plan...`);
            
            // Redirect to Stripe
            setTimeout(() => {
                window.location.href = link;
            }, 1000);
        }

        // --- STANDARD APP LOGIC ---

        window.openModal = function(id) { 
            const m = document.getElementById(id);
            if(m) m.classList.add('open'); 
        }
        window.closeModal = function(id) { 
            const m = id ? document.getElementById(id) : document.querySelector('.modal.open');
            if(m) m.classList.remove('open'); 
        }
        
        window.loginWithGoogle = function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch((error) => { showToast("Login Failed: " + error.message); });
        }

        window.logout = function() {
            auth.signOut().then(() => {
                state.isSubscribed = false; 
                state.subscriptionTier = null;
                showToast("Logged Out");
            });
        }

        function updateAuthState() {
            const loginBtn = document.getElementById('loginBtn');
            const subBtn = document.getElementById('subBtn');
            const avatar = document.getElementById('avatar');
            const tierTag = document.getElementById('tierTag');

            if (state.user) {
                loginBtn.style.display = 'none';
                avatar.style.display = 'block';
                avatar.src = state.user.photoURL || "https://ui-avatars.com/api/?name=User";
                avatar.onclick = () => { if(confirm("Log out?")) logout(); };
                
                if (state.isSubscribed) {
                    subBtn.style.display = 'none';
                    tierTag.style.display = 'inline-block';
                    tierTag.innerText = state.subscriptionTier ? state.subscriptionTier.toUpperCase() : 'PRO';
                } else {
                    subBtn.style.display = 'flex';
                    tierTag.style.display = 'none';
                }
            } else {
                loginBtn.style.display = 'flex';
                subBtn.style.display = 'none';
                avatar.style.display = 'none';
                tierTag.style.display = 'none';
            }
            renderList();
        }

        window.updateType = function(type) {
            state.activeType = type;
            state.activeCategory = 'all';
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === type || (type === 'all' && btn.innerText === 'All'));
            });
            renderSubFilters();
            renderList();
        }

        window.updateCategory = function(cat) {
            state.activeCategory = cat;
            renderSubFilters();
            renderList();
        }

        function renderSubFilters() {
            els.subFilters.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = `chip ${state.activeCategory === 'all' ? 'active' : ''}`;
            allBtn.innerText = 'View All';
            allBtn.onclick = () => updateCategory('all');
            els.subFilters.appendChild(allBtn);

            const cats = categoriesByType[state.activeType] || [];
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `chip ${state.activeCategory === cat ? 'active' : ''}`;
                btn.innerText = cat;
                btn.onclick = () => updateCategory(cat);
                els.subFilters.appendChild(btn);
            });
        }

        function renderList() {
            els.list.innerHTML = '';
            const filtered = fullLibrary.filter(t => {
                const typeMatch = state.activeType === 'all' || t.type === state.activeType;
                const catMatch = state.activeCategory === 'all' || t.category === state.activeCategory;
                const searchMatch = t.title.toLowerCase().includes(state.search);
                return typeMatch && catMatch && searchMatch;
            });

            if(!filtered.length) {
                els.list.innerHTML = `<div style="text-align:center; padding:3rem; color:var(--text-muted);">No sounds found.</div>`;
                return;
            }

            filtered.forEach(t => {
                const row = document.createElement('div');
                const isCur = state.playingId === t.id;
                row.className = `track-row ${isCur && state.isPlaying ? 'playing' : ''}`;
                row.onclick = (e) => { 
                    if(!e.target.closest('button')) playTrack(t.id); 
                };

                const playIcon = isCur && state.isPlaying 
                    ? '<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' 
                    : '<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';

                const isLocked = !state.user || !state.isSubscribed;
                const lockClass = isLocked ? 'locked' : '';

                row.innerHTML = `
                    <div class="col-play">
                        <button class="play-btn-small" onclick="event.stopPropagation(); playTrack(${t.id})">${playIcon}</button>
                    </div>
                    <div class="track-info">
                        <h3>${t.title}</h3>
                        <span>${t.artist}</span>
                    </div>
                    <div class="col-meta"><span class="badge">${t.category}</span></div>
                    <div class="col-meta meta" id="dur-${t.id}">${t.duration}</div>
                    <div class="visualizer">
                        ${Array.from({length: 12}).map(() => `<div class="v-bar" style="height: ${Math.floor(Math.random() * 16 + 4)}px; animation-duration:${0.4 + Math.random()}s"></div>`).join('')}
                    </div>
                    <div class="col-action">
                        <button class="action-btn" onclick="toggleLike(this, event)" title="Like">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                        <button class="action-btn ${lockClass}" onclick="downloadItem('${t.url}', event)" title="Download">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        </button>
                    </div>
                `;
                els.list.appendChild(row);
            });
        }

        window.toggleLike = function(btn, e) {
            e.stopPropagation();
            btn.classList.toggle('liked');
            showToast(btn.classList.contains('liked') ? "Added to Favorites" : "Removed from Favorites");
        }

        window.downloadItem = function(url, e) {
            e.stopPropagation();
            if(!state.user) {
                openModal('loginModal');
                return;
            }
            if(!state.isSubscribed) {
                openModal('pricingModal'); 
                return;
            }
            showToast("Starting Download...");
            window.open(url, '_blank');
        }

        function getIndex(id) { return fullLibrary.findIndex(t => t.id === id); }

        window.playNext = function() {
            if(!state.playingId) return;
            let idx = getIndex(state.playingId);
            if(idx < fullLibrary.length - 1) playTrack(fullLibrary[idx + 1].id);
            else playTrack(fullLibrary[0].id);
        }

        window.playPrev = function() {
            if(!state.playingId) return;
            let idx = getIndex(state.playingId);
            if(idx > 0) playTrack(fullLibrary[idx - 1].id);
            else playTrack(fullLibrary[fullLibrary.length - 1].id);
        }

        function playTrack(id) {
            const track = fullLibrary.find(t => t.id === id);
            
            if(state.playingId === id) {
                if(state.isPlaying) {
                    audio.pause();
                    state.isPlaying = false;
                } else {
                    audio.play();
                    state.isPlaying = true;
                }
            } else {
                state.playingId = id;
                state.isPlaying = true;
                audio.src = track.url;
                audio.play().catch(e => { console.warn(e); showToast("Error: File not found"); });
                els.pTitle.innerText = track.title;
                els.pArtist.innerText = track.artist;
                els.playerBar.classList.add('active');
            }
            updateUI();
        }

        function updateUI() {
            renderList();
            if(state.isPlaying) els.playerBar.classList.add('playing');
            else els.playerBar.classList.remove('playing');
            
            const icon = state.isPlaying 
                ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
                : '<path d="M8 5v14l11-7z"/>';
            els.mainPlayIcon.innerHTML = icon;
        }

        function preloadDurations() {
            fullLibrary.forEach(track => {
                if(track.url.includes('Risers/')) {
                    const tmp = new Audio(track.url);
                    tmp.addEventListener('loadedmetadata', () => {
                        const dur = tmp.duration;
                        if(isFinite(dur)) {
                            const m = Math.floor(dur/60);
                            const s = Math.floor(dur%60);
                            track.duration = `${m}:${s<10?'0':''}${s}`;
                            const el = document.getElementById(`dur-${track.id}`);
                            if(el) el.innerText = track.duration;
                        }
                    });
                }
            });
        }

        function showToast(msg) {
            els.toast.innerText = msg;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 2000);
        }

        function setupEvents() {
            audio.addEventListener('timeupdate', () => {
                if(!isNaN(audio.duration)) {
                    const pct = (audio.currentTime / audio.duration) * 100;
                    els.seekBar.value = pct;
                    const cm = Math.floor(audio.currentTime/60);
                    const cs = Math.floor(audio.currentTime%60);
                    els.timeCurrent.innerText = `${cm}:${cs<10?'0':''}${cs}`;
                    const tm = Math.floor(audio.duration/60);
                    const ts = Math.floor(audio.duration%60);
                    els.timeTotal.innerText = `${tm}:${ts<10?'0':''}${ts}`;
                    els.seekBar.style.background = `linear-gradient(to right, var(--text-main) ${pct}%, var(--border) ${pct}%)`;
                }
            });
            audio.addEventListener('ended', () => { state.isPlaying = false; updateUI(); });
            
            els.seekBar.addEventListener('input', (e) => { audio.currentTime = (e.target.value / 100) * audio.duration; });
            els.volBar.addEventListener('input', (e) => { audio.volume = e.target.value; });
            
            const clearBtn = document.getElementById('clearSearch');
            els.searchInput.addEventListener('input', (e) => {
                state.search = e.target.value.toLowerCase();
                renderList();
            });
            clearBtn.addEventListener('click', () => {
                els.searchInput.value = '';
                state.search = '';
                renderList();
            });

            document.getElementById('mainPlayBtn').addEventListener('click', () => { if(state.playingId) playTrack(state.playingId); });
            document.getElementById('themeToggle').addEventListener('click', () => {
                const html = document.documentElement;
                html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            });
        }

        init();
    </script>
</body>
</html>
