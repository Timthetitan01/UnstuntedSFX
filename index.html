<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicLibrary | Ultimate Collection</title>

    <script src="https://js.stripe.com/v3/"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-body: #fbfbfd;
            --bg-surface: #ffffff;
            --bg-surface-hover: #f5f5f7;
            --text-main: #1d1d1f;
            --text-muted: #86868b;
            --border: rgba(0,0,0,0.06);
            --accent: #0071e3;
            --accent-glow: rgba(0, 113, 227, 0.3);
            
            --nav-height: 110px;
            --radius: 14px;
            --shadow: 0 4px 20px rgba(0,0,0,0.03);
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #050505;
            --bg-surface: #141416;
            --bg-surface-hover: #1f1f22;
            --text-main: #f5f5f7;
            --text-muted: #98989d;
            --border: rgba(255,255,255,0.08);
            --accent: #2997ff;
            --accent-glow: rgba(41, 151, 255, 0.4);
            --shadow: 0 4px 30px rgba(0,0,0,0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 140px;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HERO --- */
        .hero {
            height: 220px;
            background: radial-gradient(circle at top right, rgba(41, 151, 255, 0.1) 0%, transparent 40%),
                        linear-gradient(180deg, var(--bg-surface) 0%, var(--bg-body) 100%);
            display: flex; flex-direction: column; justify-content: center;
            padding: 0 2rem;
        }
        
        .brand-large {
            font-size: 3.5rem; font-weight: 800; letter-spacing: -0.04em;
            background: linear-gradient(90deg, #2997ff, #db00ff, #2997ff);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            max-width: 1200px; margin: 0 auto; width: 100%;
            animation: shine 5s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* --- STICKY NAV --- */
        .sticky-nav {
            position: sticky; top: 0;
            z-index: 100;
            background: rgba(var(--bg-body), 0.85);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        }
        
        .nav-content {
            max-width: 1200px; margin: 0 auto; padding: 0 2rem;
            display: flex; flex-direction: column; gap: 1rem;
        }

        .top-row { display: flex; justify-content: space-between; align-items: center; }

        /* Auth Buttons */
        .auth-actions { display: flex; gap: 10px; align-items: center; }
        .btn-primary {
            background: var(--text-main); color: var(--bg-body); border: none;
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: 0.2s var(--ease); display: flex; align-items: center; gap: 6px;
        }
        .btn-primary:hover { transform: scale(1.05); }
        .btn-sub { background: var(--accent); color: white; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: none; border: 2px solid var(--accent); object-fit: cover; }
        .tier-tag { font-size: 0.75rem; font-weight: bold; color: var(--accent); border: 1px solid var(--accent); padding: 2px 8px; border-radius: 12px; display: none; }

        /* Filters */
        .type-switcher { display: inline-flex; background: var(--bg-surface); padding: 4px; border-radius: 14px; border: 1px solid var(--border); }
        .type-btn { padding: 8px 24px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .type-btn.active { background: var(--text-main); color: var(--bg-body); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .sub-filters { display: flex; gap: 0.6rem; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .sub-filters::-webkit-scrollbar { display: none; }
        .chip { padding: 0.5rem 1.2rem; border-radius: 24px; font-size: 0.85rem; font-weight: 500; background: transparent; color: var(--text-muted); border: 1px solid var(--border); cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- LIST --- */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }

        .search-wrap { margin-bottom: 2rem; position: relative; max-width: 600px; }
        .search-input { width: 100%; padding: 1rem 3rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; color: var(--text-main); font-size: 1rem; transition: 0.2s; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .search-icon { position: absolute; left: 1.2rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 20px; }
        .clear-search { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: var(--bg-surface-hover); border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); opacity: 0; pointer-events: none; transition: 0.2s; }
        .search-input:not(:placeholder-shown) ~ .clear-search { opacity: 1; pointer-events: all; }

        .track-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .track-row {
            display: grid; grid-template-columns: 60px 3fr 1fr 80px 80px 100px;
            align-items: center; background: transparent; border: 1px solid transparent;
            border-bottom: 1px solid var(--border); padding: 0.8rem 1rem; border-radius: var(--radius); cursor: pointer; transition: all 0.2s var(--ease);
        }
        .track-row:hover { background: var(--bg-surface); transform: scale(1.005); box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 1; border-color: transparent; }
        .track-row.playing { background: var(--bg-surface); border-color: var(--accent); }
        .track-row.playing h3 { color: var(--accent); }

        .play-btn-small { width: 38px; height: 38px; border-radius: 50%; background: var(--bg-surface-hover); border: 1px solid transparent; color: var(--text-main); display: flex; align-items: center; justify-content: center; transition: 0.2s; opacity: 0.7; cursor: pointer; }
        .track-row:hover .play-btn-small { opacity: 1; background: var(--text-main); color: var(--bg-body); }
        .track-row.playing .play-btn-small { opacity: 1; background: var(--accent); color: white; }

        .track-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
        .track-info span { font-size: 0.85rem; color: var(--text-muted); }
        .badge { background: var(--bg-surface-hover); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .meta { color: var(--text-muted); font-size: 0.85rem; font-variant-numeric: tabular-nums; }
        
        .col-action { display: flex; gap: 0.5rem; justify-content: flex-end; opacity: 0; transition: 0.2s; }
        .track-row:hover .col-action { opacity: 1; }
        
        .action-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .action-btn:hover { background: var(--bg-surface-hover); color: var(--text-main); }
        .action-btn.liked { color: #ff3b30; }
        
        /* Lock visual for non-subscribed */
        .action-btn.locked::after { content: "ðŸ”’"; position: absolute; font-size: 10px; bottom: -2px; right: -2px; }
        .action-btn.locked { opacity: 0.6; }

        .visualizer { display: flex; align-items: center; gap: 3px; height: 24px; opacity: 0.5; }
        .track-row.playing .visualizer { opacity: 1; }
        .v-bar { width: 3px; background: var(--text-muted); border-radius: 2px; transition: height 0.2s; }
        .track-row.playing .v-bar { background: var(--accent); animation: bounce 0.6s infinite ease-in-out alternate; }
        @keyframes bounce { 0% { height: 4px; } 100% { height: 24px; } }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(150%);
            width: 95%; max-width: 900px;
            background: rgba(20, 20, 22, 0.9); backdrop-filter: blur(50px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; padding: 1.2rem 2rem;
            display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); z-index: 500;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        [data-theme="light"] .player-bar { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); }
        .player-bar.active { transform: translateX(-50%) translateY(0); }

        .player-top { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 0.8rem; }
        .p-info { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .p-art { width: 48px; height: 48px; background: linear-gradient(135deg, #333, #111); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .p-text h4 { font-size: 1rem; margin-bottom: 3px; color: var(--text-main); }
        .p-text span { font-size: 0.85rem; color: var(--text-muted); }
        
        .p-controls { display: flex; align-items: center; gap: 1.5rem; }
        .btn-ctrl { background: none; border: none; color: var(--text-main); cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .btn-ctrl:hover { opacity: 1; transform: scale(1.1); }
        .btn-play-lg { width: 56px; height: 56px; background: var(--text-main); color: var(--bg-body); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-play-lg:hover { transform: scale(1.05); background: var(--accent); color: white; }

        .player-bottom { display: flex; align-items: center; gap: 1rem; width: 100%; }
        .time-display { font-size: 0.75rem; color: var(--text-muted); min-width: 40px; }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: var(--text-main); margin-top: -4px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--border); }
        .seek-bar { flex: 1; } 
        .vol-wrap { display: flex; align-items: center; gap: 0.5rem; width: 80px; }

        /* --- MODAL (Common) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.open { display: flex; opacity: 1; }
        
        .modal-content {
            background: var(--bg-surface); padding: 2rem; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            transform: translateY(20px); transition: transform 0.3s;
            position: relative;
        }
        /* Wider modal for subscriptions */
        .modal-content.wide { max-width: 900px; padding: 3rem 2rem; }

        .modal.open .modal-content { transform: translateY(0); }
        
        .modal h2 { margin-bottom: 0.5rem; }
        .modal p { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem; }
        .google-btn {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--bg-surface); color: var(--text-main);
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
        }
        .google-btn:hover { background: var(--bg-surface-hover); border-color: var(--text-muted); }
        .close-modal { position: absolute; top: 1rem; right: 1rem; cursor: pointer; color: var(--text-muted); font-size: 1.2rem; }

        /* --- SUBSCRIPTION TIERS CSS --- */
        .tiers-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;
            margin-top: 1rem;
        }
        .tier-card {
            background: var(--bg-surface-hover); border: 1px solid var(--border);
            border-radius: 18px; padding: 2rem; text-align: left;
            transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .tier-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: var(--accent); }
        .tier-card.featured { border: 2px solid var(--accent); background: rgba(41, 151, 255, 0.05); }
        .tier-badge {
            position: absolute; top: 10px; right: 10px; background: var(--accent); color: white;
            font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: bold;
        }
        .tier-name { font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; }
        .tier-price { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-bottom: 1.5rem; }
        .tier-price span { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .tier-features { list-style: none; margin-bottom: 2rem; flex: 1; }
        .tier-features li { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.8rem; }
        .tier-features li svg { color: var(--accent); min-width: 16px; }
        
        .btn-tier {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            background: var(--text-main); color: var(--bg-body); font-weight: 600;
            cursor: pointer; transition: 0.2s; text-align: center;
        }
        .btn-tier:hover { opacity: 0.9; transform: scale(1.02); }
        .tier-card.featured .btn-tier { background: var(--accent); color: white; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--text-main); color: var(--bg-body); padding: 10px 20px; border-radius: 30px; font-weight: 600; z-index: 3000; transition: transform 0.4s; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @media (max-width: 768px) {
            .track-row { grid-template-columns: 50px 1fr 50px; grid-template-areas: "play title action" "play meta action"; gap: 0 0.5rem; }
            .col-play { grid-area: play; } .track-info { grid-area: title; }
            .badge, .visualizer { display: none; } .col-meta { grid-area: meta; } .col-action { grid-area: action; opacity: 1; }
            .hero { height: 180px; } .brand-large { font-size: 2.2rem; }
            .vol-wrap { display: none; }
        }
    </style>
</head>
<body>

    <div class="toast" id="toast">Welcome</div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">âœ•</span>
            <h2>Sign in to SonicLibrary</h2>
            <p>Access your pro assets, sync your favorites, and manage your subscription.</p>
            <button class="google-btn" onclick="loginWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
                Continue with Google
            </button>
        </div>
    </div>

    <div id="subModal" class="modal">
        <div class="modal-content wide">
            <span class="close-modal" onclick="closeModal('subModal')">âœ•</span>
            <h2>Choose Your Plan</h2>
            <p>Unlock the full potential of SonicLibrary. Cancel anytime.</p>
            
            <div class="tiers-grid">
                <div class="tier-card">
                    <div class="tier-name">Starter</div>
                    <div class="tier-price">$9<span>/mo</span></div>
                    <ul class="tier-features">
                        <li><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> 50 Downloads / mo</li>
                        <li><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Standard Quality</li>
                    </ul>
                    <button class="btn-tier" onclick="checkout('starter')">Choose Starter</button>
                </div>

                <div class="tier-card featured">
                    <div class="tier-badge">POPULAR</div>
                    <div class="tier-name">Pro</div>
                    <div class="tier-price">$19<span>/mo</span></div>
                    <ul class="tier-features">
                        <li><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Unlimited Downloads</li>
                        <li><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> High-Res WAV & FLAC</li>
                    </ul>
                    <button class="btn-tier" onclick="checkout('pro')">Choose Pro</button>
                </div>

                <div class="tier-card">
                    <div class="tier-name">Ultimate</div>
                    <div class="tier-price">$29<span>/mo</span></div>
                    <ul class="tier-features">
                        <li><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Unlimited Everything</li>
                        <li><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Team Access (up to 3)</li>
                    </ul>
                    <button class="btn-tier" onclick="checkout('ultimate')">Choose Ultimate</button>
                </div>
            </div>
        </div>
    </div>

    <div class="hero">
        <div class="brand-large">SonicLibrary</div>
    </div>

    <div class="sticky-nav">
        <div class="nav-content">
            <div class="top-row">
                <div class="type-switcher">
                    <button class="type-btn active" onclick="updateType('all')">All</button>
                    <button class="type-btn" onclick="updateType('Music')">Music</button>
                    <button class="type-btn" onclick="updateType('SFX')">SFX</button>
                </div>
                
                <div class="auth-actions">
                    <button class="btn-primary" id="loginBtn" onclick="openModal('loginModal')">Login</button>
                    <button class="btn-primary btn-sub" id="subBtn" onclick="openModal('subModal')" style="display:none;">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                        Subscribe
                    </button>
                    
                    <span id="tierTag" class="tier-tag">PRO</span>
                    <img id="avatar" class="user-avatar" src="" alt="User" title="Click to Logout">
                    
                    <button class="play-btn-small" id="themeToggle" style="border:none; box-shadow: var(--shadow); background: var(--bg-surface);">
                        <svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29zm1.41-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.29 1.29c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.29-1.29zM7.28 17.17c-.39-.39-1.02-.39-1.41 0a.996.996 0 000 1.41l1.29 1.29c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.29-1.29z"/></svg>
                    </button>
                </div>
            </div>
            <div class="sub-filters" id="subFilters"></div>
        </div>
    </div>

    <main class="container">
        <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Search library (e.g. 'alien', 'piano')...">
            <button class="clear-search" id="clearSearch"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 19 17.59 13.41 12z"/></svg></button>
        </div>

        <div class="track-list" id="trackList"></div>
    </main>

    <div class="player-bar" id="playerBar">
        <div class="player-top">
            <div class="p-info">
                <div class="p-art"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg></div>
                <div class="p-text"><h4 id="pTitle">Select a track</h4><span id="pArtist">--</span></div>
            </div>
            <div class="p-controls">
                <button class="btn-ctrl" onclick="playPrev()" title="Previous"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn-ctrl btn-play-lg" id="mainPlayBtn"><svg id="mainPlayIcon" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-ctrl" onclick="playNext()" title="Next"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            </div>
        </div>
        <div class="player-bottom">
            <span class="time-display" id="timeCurrent">0:00</span>
            <input type="range" class="seek-bar" id="seekBar" value="0" min="0" max="100">
            <span class="time-display" id="timeTotal">0:00</span>
            <div class="vol-wrap">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <input type="range" id="volBar" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
           apiKey: "YOUR_FIREBASE_API_KEY",
           authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
           projectId: "YOUR_PROJECT_ID",
           storageBucket: "YOUR_PROJECT_ID.appspot.com",
           messagingSenderId: "YOUR_SENDER_ID",
           appId: "YOUR_APP_ID"
        };
        
        // --- IMPORTANT: YOUR STRIPE LINKS ---
        // Go to Stripe Dashboard -> Payment Links -> Create New
        // Paste the URLs here for each tier.
        const STRIPE_LINKS = {
            'starter': 'https://buy.stripe.com/test_1', // e.g. https://buy.stripe.com/test_...
            'pro': 'https://buy.stripe.com/test_2',
            'ultimate': 'https://buy.stripe.com/test_3'
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- HELPERS (Library Data) ---
        function cleanTitle(filename) {
            let name = filename.replace(/\.(mp3|wav|flac|ogg|aif|m4a).*/gi, '');
            name = name.replace(/_/g, ' ').replace(/-/g, ' ');
            name = name.replace(/\w\S*/g, (w) => (w.replace(/^\w/, (c) => c.toUpperCase())));
            const words = name.split(/\s+/);
            if(words.length > 3) return words.slice(0, 3).join(' ');
            return name;
        }

        const library = [
             { id: 101, title: "Deep Bass Pulse", artist: "Local Library", type: "SFX", category: "Riser", duration: "--:--", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
             { id: 102, title: "Neon Cyber Chase", artist: "Local Library", type: "Music", category: "Techno", duration: "--:--", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
             { id: 103, title: "Alien Atmosphere", artist: "Local Library", type: "SFX", category: "Sci-Fi", duration: "--:--", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }
        ];

        const webFiles = [
             { id: 1, title: "Uplifting Tech Bed", artist: "Corporate Music", type: "Music", category: "Electronic", duration: "2:10", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
             { id: 2, title: "Lo-Fi Study Beat", artist: "Chillhop", type: "Music", category: "Electronic", duration: "1:30", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" }
        ];
        
        const fullLibrary = [...webFiles, ...library];

        const categoriesByType = {
            'all': ['Riser', 'Techno', 'Electronic', 'Sci-Fi'],
            'Music': ['Techno', 'Electronic'],
            'SFX': ['Riser', 'Sci-Fi']
        };

        const state = { 
            playingId: null, 
            isPlaying: false, 
            activeType: 'all', 
            activeCategory: 'all', 
            search: '', 
            user: null, 
            isSubscribed: false,
            subscriptionTier: null,
            subscriptionEnd: null
        };
        const audio = new Audio();
        
        const els = {
            list: document.getElementById('trackList'),
            subFilters: document.getElementById('subFilters'),
            playerBar: document.getElementById('playerBar'),
            pTitle: document.getElementById('pTitle'),
            pArtist: document.getElementById('pArtist'),
            mainPlayIcon: document.getElementById('mainPlayIcon'),
            timeCurrent: document.getElementById('timeCurrent'),
            timeTotal: document.getElementById('timeTotal'),
            seekBar: document.getElementById('seekBar'),
            volBar: document.getElementById('volBar'),
            searchInput: document.getElementById('searchInput'),
            toast: document.getElementById('toast'),
            tierTag: document.getElementById('tierTag')
        };

        function init() {
            renderSubFilters();
            renderList();
            setupEvents();
            
            // Check for Return from Stripe
            checkPaymentSuccess();

            // Listen for Auth State Changes
            auth.onAuthStateChanged(async (user) => {
                state.user = user;
                if(user) {
                    // Check Firestore for Subscription Status
                    await checkSubscriptionStatus(user.uid);
                    
                    showToast(`Welcome, ${user.displayName || 'User'}`);
                    closeModal('loginModal');
                    
                    if(!state.isSubscribed) {
                        setTimeout(() => openModal('subModal'), 1500);
                    }
                } else {
                    state.isSubscribed = false;
                    state.subscriptionTier = null;
                }
                updateAuthState();
            });
        }

        // --- 2. FIRESTORE & AUTH LOGIC ---

        // Check user's subscription in Firestore
        async function checkSubscriptionStatus(uid) {
            try {
                const docRef = db.collection('users').doc(uid);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    // Logic: Is there a subscription and has it not expired?
                    if (data.isPremium && data.subscriptionEnd > now) {
                        state.isSubscribed = true;
                        state.subscriptionTier = data.tier;
                        state.subscriptionEnd = data.subscriptionEnd;
                        console.log(`User has active ${data.tier} subscription until ${new Date(data.subscriptionEnd)}`);
                    } else {
                        state.isSubscribed = false;
                        state.subscriptionTier = null;
                    }
                }
            } catch (error) {
                console.error("Error fetching subscription:", error);
            }
            updateAuthState(); // Update UI based on new state
        }

        // Handle return from Stripe (Successful Payment)
        async function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            // Stripe adds ?success=true or session_id if configured
            if (urlParams.get('success') === 'true' && auth.currentUser) {
                
                showToast("Verifying Payment...");
                
                // --- SECURITY WARNING ---
                // In a REAL app, this update happens via Stripe Webhook -> Cloud Function.
                // Updating this client-side is insecure but functional for this demo.
                
                const uid = auth.currentUser.uid;
                // Default to 'pro' if we can't track exactly which button was clicked in this simple demo
                // You can store 'pendingTier' in localStorage before redirect to be more accurate
                const tier = localStorage.getItem('pendingTier') || 'pro'; 
                
                // Grant 30 days access
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const expiration = Date.now() + thirtyDays;

                await db.collection('users').doc(uid).set({
                    isPremium: true,
                    tier: tier,
                    subscriptionEnd: expiration,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                state.isSubscribed = true;
                state.subscriptionTier = tier;
                
                showToast("Subscription Activated!");
                
                // Clean URL
                window.history.replaceState({}, document.title, "/");
                updateAuthState();
            }
        }

        // --- 3. CHECKOUT FUNCTION ---
        window.checkout = async function(tierId) {
            if(!state.user) {
                alert("Please login first to subscribe.");
                openModal('loginModal');
                return;
            }

            const link = STRIPE_LINKS[tierId];
            if(!link || link.includes('test_1')) {
                alert("Please configure your Stripe Link IDs in the code first.");
                return;
            }

            // Save the tier they are trying to buy to localStorage so we know what to give them on return
            localStorage.setItem('pendingTier', tierId);

            showToast(`Redirecting to ${tierId} plan...`);
            
            // Redirect to Stripe
            // Important: Configure your Stripe Link to redirect back to: https://yoursite.com/?success=true
            setTimeout(() => {
                window.location.href = link;
            }, 1000);
        }

        // --- STANDARD APP LOGIC ---

        window.openModal = function(id) { document.getElementById(id).classList.add('open'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); }
        
        window.loginWithGoogle = function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch((error) => { showToast("Login Failed: " + error.message); });
        }

        window.logout = function() {
            auth.signOut().then(() => {
                state.isSubscribed = false; 
                state.subscriptionTier = null;
                showToast("Logged Out");
            });
        }

        function updateAuthState() {
            const loginBtn = document.getElementById('loginBtn');
            const subBtn = document.getElementById('subBtn');
            const avatar = document.getElementById('avatar');
            const tierTag = document.getElementById('tierTag');

            if (state.user) {
                loginBtn.style.display = 'none';
                avatar.style.display = 'block';
                avatar.src = state.user.photoURL || "https://ui-avatars.com/api/?name=User";
                avatar.onclick = () => { if(confirm("Log out?")) logout(); };
                
                if (state.isSubscribed) {
                    subBtn.style.display = 'none';
                    tierTag.style.display = 'inline-block';
                    tierTag.innerText = state.subscriptionTier ? state.subscriptionTier.toUpperCase() : 'PRO';
                } else {
                    subBtn.style.display = 'flex';
                    tierTag.style.display = 'none';
                }
            } else {
                loginBtn.style.display = 'flex';
                subBtn.style.display = 'none';
                avatar.style.display = 'none';
                tierTag.style.display = 'none';
            }
            renderList();
        }

        window.updateType = function(type) {
            state.activeType = type;
            state.activeCategory = 'all';
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === type || (type === 'all' && btn.innerText === 'All'));
            });
            renderSubFilters();
            renderList();
        }

        window.updateCategory = function(cat) {
            state.activeCategory = cat;
            renderSubFilters();
            renderList();
        }

        function renderSubFilters() {
            els.subFilters.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = `chip ${state.activeCategory === 'all' ? 'active' : ''}`;
            allBtn.innerText = 'View All';
            allBtn.onclick = () => updateCategory('all');
            els.subFilters.appendChild(allBtn);

            const cats = categoriesByType[state.activeType] || [];
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `chip ${state.activeCategory === cat ? 'active' : ''}`;
                btn.innerText = cat;
                btn.onclick = () => updateCategory(cat);
                els.subFilters.appendChild(btn);
            });
        }

        function renderList() {
            els.list.innerHTML = '';
            const filtered = fullLibrary.filter(t => {
                const typeMatch = state.activeType === 'all' || t.type === state.activeType;
                const catMatch = state.activeCategory === 'all' || t.category === state.activeCategory;
                const searchMatch = t.title.toLowerCase().includes(state.search);
                return typeMatch && catMatch && searchMatch;
            });

            if(!filtered.length) {
                els.list.innerHTML = `<div style="text-align:center; padding:3rem; color:var(--text-muted);">No sounds found.</div>`;
                return;
            }

            filtered.forEach(t => {
                const row = document.createElement('div');
                const isCur = state.playingId === t.id;
                row.className = `track-row ${isCur && state.isPlaying ? 'playing' : ''}`;
                row.onclick = (e) => { 
                    if(!e.target.closest('button')) playTrack(t.id); 
                };

                const playIcon = isCur && state.isPlaying 
                    ? '<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' 
                    : '<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';

                const isLocked = !state.user || !state.isSubscribed;
                const lockClass = isLocked ? 'locked' : '';

                row.innerHTML = `
                    <div class="col-play">
                        <button class="play-btn-small" onclick="event.stopPropagation(); playTrack(${t.id})">${playIcon}</button>
                    </div>
                    <div class="track-info">
                        <h3>${t.title}</h3>
                        <span>${t.artist}</span>
                    </div>
                    <div class="col-meta"><span class="badge">${t.category}</span></div>
                    <div class="col-meta meta" id="dur-${t.id}">${t.duration}</div>
                    <div class="visualizer">
                        ${Array.from({length: 12}).map(() => `<div class="v-bar" style="height: ${Math.floor(Math.random() * 16 + 4)}px; animation-duration:${0.4 + Math.random()}s"></div>`).join('')}
                    </div>
                    <div class="col-action">
                        <button class="action-btn" onclick="toggleLike(this, event)" title="Like">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                        <button class="action-btn ${lockClass}" onclick="downloadItem('${t.url}', event)" title="Download">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        </button>
                    </div>
                `;
                els.list.appendChild(row);
            });
        }

        window.toggleLike = function(btn, e) {
            e.stopPropagation();
            btn.classList.toggle('liked');
            showToast(btn.classList.contains('liked') ? "Added to Favorites" : "Removed from Favorites");
        }

        window.downloadItem = function(url, e) {
            e.stopPropagation();
            if(!state.user) {
                openModal('loginModal');
                return;
            }
            if(!state.isSubscribed) {
                openModal('subModal'); 
                return;
            }
            showToast("Starting Download...");
            window.open(url, '_blank');
        }

        function getIndex(id) { return fullLibrary.findIndex(t => t.id === id); }

        window.playNext = function() {
            if(!state.playingId) return;
            let idx = getIndex(state.playingId);
            if(idx < fullLibrary.length - 1) playTrack(fullLibrary[idx + 1].id);
            else playTrack(fullLibrary[0].id);
        }

        window.playPrev = function() {
            if(!state.playingId) return;
            let idx = getIndex(state.playingId);
            if(idx > 0) playTrack(fullLibrary[idx - 1].id);
            else playTrack(fullLibrary[fullLibrary.length - 1].id);
        }

        function playTrack(id) {
            const track = fullLibrary.find(t => t.id === id);
            
            if(state.playingId === id) {
                if(state.isPlaying) {
                    audio.pause();
                    state.isPlaying = false;
                } else {
                    audio.play();
                    state.isPlaying = true;
                }
            } else {
                state.playingId = id;
                state.isPlaying = true;
                audio.src = track.url;
                audio.play().catch(e => { console.warn(e); showToast("Error: File not found"); });
                els.pTitle.innerText = track.title;
                els.pArtist.innerText = track.artist;
                els.playerBar.classList.add('active');
            }
            updateUI();
        }

        function updateUI() {
            renderList();
            if(state.isPlaying) els.playerBar.classList.add('playing');
            else els.playerBar.classList.remove('playing');
            
            const icon = state.isPlaying 
                ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
                : '<path d="M8 5v14l11-7z"/>';
            els.mainPlayIcon.innerHTML = icon;
        }

        function showToast(msg) {
            els.toast.innerText = msg;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 2000);
        }

        function setupEvents() {
            audio.addEventListener('timeupdate', () => {
                if(!isNaN(audio.duration)) {
                    const pct = (audio.currentTime / audio.duration) * 100;
                    els.seekBar.value = pct;
                    const cm = Math.floor(audio.currentTime/60);
                    const cs = Math.floor(audio.currentTime%60);
                    els.timeCurrent.innerText = `${cm}:${cs<10?'0':''}${cs}`;
                    const tm = Math.floor(audio.duration/60);
                    const ts = Math.floor(audio.duration%60);
                    els.timeTotal.innerText = `${tm}:${ts<10?'0':''}${ts}`;
                    els.seekBar.style.background = `linear-gradient(to right, var(--text-main) ${pct}%, var(--border) ${pct}%)`;
                }
            });
            audio.addEventListener('ended', () => { state.isPlaying = false; updateUI(); });
            
            els.seekBar.addEventListener('input', (e) => { audio.currentTime = (e.target.value / 100) * audio.duration; });
            els.volBar.addEventListener('input', (e) => { audio.volume = e.target.value; });
            
            const clearBtn = document.getElementById('clearSearch');
            els.searchInput.addEventListener('input', (e) => {
                state.search = e.target.value.toLowerCase();
                renderList();
            });
            clearBtn.addEventListener('click', () => {
                els.searchInput.value = '';
                state.search = '';
                renderList();
            });

            document.getElementById('mainPlayBtn').addEventListener('click', () => { if(state.playingId) playTrack(state.playingId); });
            document.getElementById('themeToggle').addEventListener('click', () => {
                const html = document.documentElement;
                html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            });
        }

        init();
    </script>
</body>
</html>